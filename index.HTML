<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Pro | Dashboard</title>
    
    <!-- Favicon (√çcone da Aba) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            surface: '#1e293b',
                            accent: '#3b82f6', // Azul
                            receita: '#10b981', // Verde
                            despesa: '#ef4444', // Vermelho
                            warning: '#f59e0b', // Amarelo
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #0f172a; overflow-x: hidden; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.05); color: white; }
        
        .dashboard-fullscreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 50;
            background: #0f172a;
            overflow-y: auto;
            display: none;
        }
        .dashboard-fullscreen.active { display: block; animation: fadeIn 0.3s ease-out; }

        .menu-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="text-slate-300 font-sans antialiased selection:bg-brand-accent selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0f172a] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 to-[#0f172a]">
        <div class="glass p-10 rounded-3xl max-w-md w-full text-center relative overflow-hidden border border-slate-700/50 shadow-2xl animate-fade-in">
            <div class="absolute -top-20 -left-20 w-60 h-60 bg-brand-accent/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-20 -right-20 w-60 h-60 bg-brand-receita/20 rounded-full blur-[80px]"></div>

            <div class="relative z-10">
                <div class="w-24 h-24 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl flex items-center justify-center shadow-lg border border-slate-700 mx-auto mb-8">
                    <i class="fa-solid fa-chart-pie text-brand-accent text-5xl"></i>
                </div>
                <h1 class="font-display text-4xl font-bold text-white mb-2">Financeiro <span class="text-brand-accent">Pro</span></h1>
                <p class="text-slate-400 mb-10">Gest√£o inteligente para suas finan√ßas.</p>
                
                <button id="btn-login-google" class="w-full bg-white hover:bg-slate-100 text-slate-900 font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl hover:scale-[1.01] group">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                    <span>Acessar com Google</span>
                </button>
                <p id="login-status" class="text-slate-400 text-xs mt-4 h-4"></p>
                <p id="login-error" class="text-brand-despesa text-xs mt-2 hidden"></p>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-content" class="hidden flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-20 lg:w-64 bg-slate-900 border-r border-slate-800 flex flex-col justify-between z-40 transition-all duration-300">
            <div>
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                    <i class="fa-solid fa-wallet text-brand-accent text-2xl lg:mr-3"></i>
                    <span class="hidden lg:block font-display font-bold text-xl text-white">Finan√ßas</span>
                </div>

                <nav class="mt-8 space-y-2 px-2">
                    <button onclick="switchView('home')" id="nav-home" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-brand-accent bg-slate-800/50 font-medium transition-all group">
                        <i class="fa-solid fa-house text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">In√≠cio</span>
                    </button>
                    
                    <button onclick="switchView('datagrid')" id="nav-datagrid" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-table-columns text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Base de Dados</span>
                    </button>

                    <button onclick="openDashboardFull()" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-brand-accent hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Dashboard</span>
                    </button>

                    <button onclick="switchView('investimentos')" id="nav-investimentos" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-piggy-bank text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">√Årea de Investimentos</span>
                    </button>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-800">
                <!-- CORRE√á√ÉO AQUI: onclick="logoutApp()" sem argumentos -->
                <div class="flex items-center gap-3 justify-center lg:justify-start cursor-pointer hover:bg-slate-800 p-2 rounded-lg transition-colors" onclick="logoutApp()">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-slate-700">
                    <div class="hidden lg:block overflow-hidden">
                        <p id="user-name" class="text-xs font-bold text-white truncate">Usu√°rio</p>
                        <p class="text-[10px] text-slate-500">Sair</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto bg-[#0f172a] relative">
            
            <!-- VIEW: HOME -->
            <div id="view-home" class="p-8 lg:p-12 max-w-7xl mx-auto animate-slide-up">
                <header class="mb-10 flex justify-between items-end">
                    <div>
                        <p class="text-brand-accent font-bold uppercase tracking-wider text-xs mb-1">Bem-vindo de volta</p>
                        <h2 class="font-display text-4xl font-bold text-white">Vis√£o Geral</h2>
                    </div>
                    <div class="text-right hidden sm:block">
                        <p id="current-date" class="text-slate-400 text-sm">...</p>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dashboard Card -->
                    <div onclick="openDashboardFull()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden col-span-1 md:col-span-2 lg:col-span-2">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-accent/10 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-brand-accent/20 transition-all"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div>
                                <div class="w-12 h-12 rounded-xl bg-brand-accent/20 text-brand-accent flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Dashboard Interativo</h3>
                                <p class="text-slate-400 max-w-md">Visualize gr√°ficos, analise tend√™ncias e acompanhe suas metas em tela cheia.</p>
                            </div>
                            <div class="mt-6 flex items-center text-brand-accent font-bold text-sm">
                                <span>ABRIR AGORA</span>
                                <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes A√ß√£o R√°pida -->
                    <div onclick="openModal('despesa')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-despesa hover:border-brand-despesa">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-despesa/20 text-brand-despesa flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Despesa</h3>
                            <p class="text-slate-400 text-sm">Adicionar sa√≠da manual.</p>
                        </div>
                    </div>

                    <div onclick="openModal('receita')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-receita hover:border-brand-receita">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-receita/20 text-brand-receita flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Receita</h3>
                            <p class="text-slate-400 text-sm">Adicionar entrada manual.</p>
                        </div>
                    </div>

                    <!-- Base de Dados Link -->
                    <div onclick="switchView('datagrid')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden md:col-span-2">
                        <div class="relative z-10 flex items-center gap-6">
                            <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center text-2xl text-slate-300 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-database"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Base de Dados Completa</h3>
                                <p class="text-slate-400 text-sm mt-1">Gerencie, edite e filtre todas as suas transa√ß√µes em uma tabela din√¢mica.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√µes -->
                    <div onclick="openSettings()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-white mb-3 group-hover:rotate-90 transition-transform">
                            <i class="fa-solid fa-gear"></i>
                        </div>
                        <h3 class="text-white font-bold">Configura√ß√µes</h3>
                        <p class="text-xs text-slate-400 mt-1">Editar Bancos e Categorias</p>
                    </div>

                    <!-- Backup -->
                    <div onclick="openBackupModal()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-white mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <h3 class="text-white font-bold">Backup de Seguran√ßa</h3>
                        <p class="text-xs text-slate-400 mt-1">Salvar c√≥pia dos dados</p>
                    </div>

                    <!-- Importar Excel -->
                    <label class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center border border-dashed border-slate-600 hover:border-brand-accent hover:bg-slate-800/50">
                        <input type="file" id="file-upload" accept=".xlsx, .xls, .csv" class="hidden">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <h3 class="text-white font-bold">Importar Excel</h3>
                        <p id="import-status" class="text-xs text-slate-400 mt-1">Clique para carregar planilha</p>
                    </label>

                </div>
            </div>

            <!-- VIEW: DATAGRID -->
            <div id="view-datagrid" class="hidden h-full flex flex-col animate-fade-in">
                <!-- Header Grid -->
                <div class="px-8 py-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="font-display text-2xl font-bold text-white">Base de Dados</h2>
                        <p class="text-slate-400 text-sm">Gerenciamento de registros</p>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="relative">
                            <input type="month" id="filter-month" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg px-4 py-2 focus:ring-1 focus:ring-brand-accent focus:border-brand-accent outline-none transition-all cursor-pointer">
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input type="text" id="grid-search" placeholder="Buscar..." class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-1 focus:ring-brand-accent focus:border-brand-accent outline-none w-48 lg:w-64 transition-all">
                        </div>
                        <button onclick="clearAllData()" class="px-4 py-2 bg-slate-800 hover:bg-brand-despesa/20 hover:text-brand-despesa text-slate-400 rounded-lg text-sm font-bold transition-all border border-slate-700">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-8 pt-6 flex gap-6 border-b border-slate-800">
                    <button onclick="switchTableTab('receitas')" id="tab-btn-receitas" class="pb-3 px-2 border-b-2 border-brand-receita text-brand-receita font-bold text-sm uppercase tracking-wider transition-all flex items-center gap-2">
                        <i class="fa-solid fa-arrow-up"></i> Receitas
                        <span id="tab-badge-rec" class="bg-brand-receita/20 text-brand-receita text-[10px] px-2 py-0.5 rounded-full ml-1">0</span>
                    </button>
                    <button onclick="switchTableTab('despesas')" id="tab-btn-despesas" class="pb-3 px-2 border-b-2 border-transparent text-slate-500 hover:text-white font-bold text-sm uppercase tracking-wider transition-all flex items-center gap-2">
                        <i class="fa-solid fa-arrow-down"></i> Despesas
                        <span id="tab-badge-desp" class="bg-slate-800 text-slate-400 text-[10px] px-2 py-0.5 rounded-full ml-1">0</span>
                    </button>
                </div>

                <!-- Tables -->
                <div class="flex-1 overflow-auto p-8">
                    <div id="tab-content-receitas" class="h-full flex flex-col glass rounded-2xl overflow-hidden border-t-4 border-t-brand-receita animate-fade-in">
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider z-10">
                                    <tr>
                                        <th class="px-6 py-4 bg-slate-900/90">Data</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Origem</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Banco</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-right">Valor</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-receitas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-content-despesas" class="hidden h-full flex flex-col glass rounded-2xl overflow-hidden border-t-4 border-t-brand-despesa animate-fade-in">
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider z-10">
                                    <tr>
                                        <th class="px-6 py-4 bg-slate-900/90">Data</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Descri√ß√£o</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Categoria</th>
		    <th class="px-6 py-4 bg-slate-900/90">Caracter√≠stica</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Banco</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-right">Valor</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-despesas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INVESTIMENTOS -->
            <div id="view-investimentos" class="hidden p-8 lg:p-12 max-w-7xl mx-auto animate-slide-up">
                <header class="mb-10 flex justify-between items-end">
                    <div>
                        <p class="text-brand-accent font-bold uppercase tracking-wider text-xs mb-1">Seus Investimentos</p>
                        <h2 class="font-display text-4xl font-bold text-white">Carteira de Ativos</h2>
                    </div>
                </header>

                <!-- Investment KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-6 rounded-3xl">
                        <p class="text-sm text-slate-400">Total Investido</p>
                        <p id="kpi-total-investido" class="text-3xl font-bold text-white mt-1">R$ 0,00</p>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <p class="text-sm text-slate-400">M√©dia de Aportes</p>
                        <p id="kpi-media-aportes" class="text-3xl font-bold text-white mt-1">R$ 0,00</p>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <p class="text-sm text-slate-400">Meta do M√™s Atual</p>
                        <p id="kpi-meta-mes" class="text-3xl font-bold text-white mt-1">0%</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Coluna da Esquerda (Configura√ß√µes e Hist√≥rico) -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Meta de Investimento -->
                        <div class="glass p-6 rounded-3xl">
                            <h3 class="text-lg font-bold text-white mb-4">Meta Mensal</h3>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">R$</span>
                                <input type="text" id="investment-goal" class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-12 pr-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="200,00" oninput="formatCurrencyInput(this)">
                            </div>
                             <!-- Progress Bar -->
                            <div class="w-full bg-slate-700 rounded-full h-2.5 mt-4">
                              <div id="goal-progress-bar" class="bg-brand-accent h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <button onclick="saveInvestmentGoal()" class="mt-4 w-full bg-brand-accent hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition-all">
                                Salvar Meta
                            </button>
                        </div>

                        <!-- Registro de Aporte Mensal -->
                        <div class="glass p-6 rounded-3xl">
                            <h3 class="text-lg font-bold text-white mb-4">Registrar Aporte</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">M√™s</label>
                                    <input type="month" id="investment-month" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor Aportado</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">R$</span>
                                        <input type="text" id="investment-amount" class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-12 pr-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="150,00" oninput="formatCurrencyInput(this)">
                                    </div>
                                </div>
                            </div>
                            <button onclick="saveMonthlyInvestment()" class="mt-4 w-full bg-brand-receita hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition-all">
                                Registrar Investimento
                            </button>
                        </div>
                    </div>

                    <!-- Coluna da Direita (Gr√°fico e Tabela) -->
                    <div class="lg:col-span-3 space-y-6">
                        <div class="glass p-6 rounded-3xl">
                            <h3 class="text-lg font-bold text-white mb-4">Comparativo: Meta vs Aporte Realizado</h3>
                            <div class="relative h-[300px]"><canvas id="investment-bar-chart"></canvas></div>
                        </div>
                         <div class="glass p-6 rounded-3xl">
                            <h3 class="text-lg font-bold text-white mb-4">Hist√≥rico de Aportes</h3>
                            <div class="overflow-auto max-h-[200px]">
                                <table class="w-full text-left text-sm text-slate-400">
                                    <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0">
                                        <tr>
                                            <th class="px-6 py-3">M√™s</th>
                                            <th class="px-6 py-3 text-right">Valor Aportado</th>
                                            <th class="px-6 py-3 text-right">Meta Mensal</th>
                                            <th class="px-6 py-3 text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="investment-history-body" class="divide-y divide-slate-800">
                                        <!-- Linhas do hist√≥rico ser√£o inseridas aqui via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- DASHBOARD FULLSCREEN OVERLAY -->
    <div id="dashboard-full" class="dashboard-fullscreen bg-[#0f172a] text-slate-200">
        
        <!-- Dashboard Nav -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="glass-strong px-2 py-2 rounded-full flex gap-1 shadow-2xl border border-slate-700/50 items-center transition-all duration-300" id="dash-nav-container">
                <!-- Back Button -->
                <button onclick="closeDashboardFull()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition-colors" title="Voltar ao Menu">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                
                <div class="w-px h-6 bg-slate-700 my-auto mx-1"></div>
                
                <!-- Primary Month (Always Visible) -->
                <div class="flex items-center gap-2 px-2 cursor-pointer hover:bg-white/5 rounded-lg transition-colors relative group" onclick="try{document.getElementById('dash-filter-month-1').showPicker()}catch(e){document.getElementById('dash-filter-month-1').focus()}">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">M√™s:</span>
                    <input type="month" id="dash-filter-month-1" class="bg-transparent text-white font-bold text-sm outline-none border-none w-40 cursor-pointer text-center">
                </div>

                <!-- Merge Toggle Button -->
                <button onclick="toggleMerge()" id="btn-merge" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-500 hover:text-brand-accent hover:bg-white/10 transition-all ml-1" title="Mesclar Per√≠odo">
                    <i class="fa-solid fa-code-merge"></i>
                </button>

                <!-- Secondary Month (Hidden by Default) -->
                <div id="container-month-2" class="hidden flex items-center gap-2 px-2 cursor-pointer hover:bg-white/5 rounded-lg transition-colors border-l border-slate-700 ml-1 animate-fade-in" onclick="try{document.getElementById('dash-filter-month-2').showPicker()}catch(e){document.getElementById('dash-filter-month-2').focus()}">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">At√©:</span>
                    <input type="month" id="dash-filter-month-2" class="bg-transparent text-white font-bold text-sm outline-none border-none w-40 cursor-pointer text-center">
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="p-8 lg:p-16 max-w-[1600px] mx-auto mt-12 space-y-8 animate-slide-up">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Saldo -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-accent/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Saldo do Per√≠odo</p>
                    <h3 id="dash-saldo" class="text-4xl font-display font-bold text-white">R$ 0,00</h3>
                    <div class="mt-4 h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-brand-accent w-full"></div>
                    </div>
                </div>
                <!-- Receitas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-receita/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Entradas (Per√≠odo)</p>
                    <h3 id="dash-rec" class="text-4xl font-display font-bold text-brand-receita">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-receita">
                        <i class="fa-solid fa-arrow-trend-up"></i> <span>Receitas computadas</span>
                    </div>
                </div>
                <!-- Despesas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden border-transparent transition-all" id="card-despesa-kpi">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-despesa/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Sa√≠das (Per√≠odo)</p>
                    <h3 id="dash-desp" class="text-4xl font-display font-bold text-brand-despesa">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-despesa" id="kpi-despesa-status">
                         <!-- JS Populates status -->
                    </div>
                </div>
                <!-- Investimentos / Meta -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden flex flex-col justify-center items-center">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="#1e293b" stroke-width="8" fill="transparent"></circle>
                            <circle id="circle-progress" cx="48" cy="48" r="40" stroke="#3b82f6" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="transition-all duration-1000"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="dash-eco-perc" class="text-lg font-bold text-white">0%</span>
                        </div>
                    </div>
                    <div id="label-inv-goal" class="w-full text-center">
                        <p class="mt-2 text-xs text-slate-400 uppercase font-bold text-center">Meta de Investimento</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1: Flow + Top Categories (Restored) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Bar+Line Main -->
                <div class="glass p-6 rounded-3xl lg:col-span-2">
                    <h4 id="title-chart-main" class="font-bold text-white mb-1">Fluxo Financeiro</h4>
                    <p id="subtitle-chart-main" class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Hist√≥rico</p>
                    <div class="h-[300px]">
                        <canvas id="chart-main"></canvas>
                    </div>
                </div>
                <!-- Top Categories (Restored Bar) -->
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-1">Top Categorias</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Maiores Despesas (Per√≠odo)</p>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="chart-top-cat"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2: Timeline Details (Full Width) -->
            <div class="glass p-6 rounded-3xl">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h4 class="font-bold text-white mb-1">Detalhamento de Despesas (Linha do Tempo)</h4>
                        <p id="chart-timeline-total" class="text-xs text-slate-400 uppercase tracking-wider">Total do per√≠odo: R$ 0,00</p>
                    </div>
                </div>
                <div class="h-[300px] w-full">
                    <canvas id="chart-timeline"></canvas>
                </div>
            </div>

            <!-- Charts Row 3: Banks & Revenue -->
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-1">Gastos por Banco</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Distribui√ß√£o Institucional</p>
                    <div class="h-[250px]">
                        <canvas id="chart-bank"></canvas>
                    </div>
                </div>
                <div class="glass p-6 rounded-3xl">
                    <h4 id="title-chart-type" class="font-bold text-white mb-1">Fontes de Receita</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Ranking de Entradas</p>
                    <div class="h-[250px]">
                        <canvas id="chart-type"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 z-[75] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('settings-modal')"></div>
        <div class="relative w-full max-w-2xl glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-display text-xl font-bold text-white">Configura√ß√µes</h3>
                <button onclick="closeModal('settings-modal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 flex-1 overflow-auto">
                <!-- Config Metas -->
                <div class="mb-8 border-b border-slate-700 pb-6">
                    <h4 class="font-display text-white font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Defini√ß√£o de Metas (%)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Limite de Gastos</label>
                            <div class="relative">
                                <input type="number" id="setting-goal-expense" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-despesa outline-none" placeholder="80" onchange="updateGoal('goalExpense', this.value)">
                                <span class="absolute right-4 top-2 text-slate-500">%</span>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1">Alerta se gastos superarem % da receita.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Meta de Saldo/Inv.</label>
                            <div class="relative">
                                <input type="number" id="setting-goal-savings" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-receita outline-none" placeholder="20" onchange="updateGoal('goalSavings', this.value)">
                                <span class="absolute right-4 top-2 text-slate-500">%</span>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1">Objetivo de economia sobre a receita.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Config Bancos -->
                    <div>
                        <h4 class="text-brand-accent font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-building-columns"></i> Bancos</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-bank" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-accent outline-none" placeholder="Novo banco...">
                            <button onclick="addSettingItem('banks', 'new-bank')" class="bg-brand-accent hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-banks" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>

                    <!-- Config Categorias -->
                    <div>
                        <h4 class="text-brand-despesa font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-tag"></i> Categorias</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-cat" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-despesa outline-none" placeholder="Nova categoria...">
                            <button onclick="addSettingItem('categories', 'new-cat')" class="bg-brand-despesa hover:bg-rose-600 text-white px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-categories" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TRANSACTION -->
    <div id="modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('modal')"></div>
        <div class="relative w-full max-w-lg glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 id="modal-title" class="font-display text-xl font-bold text-white">Nova Transa√ß√£o</h3>
                <button onclick="closeModal('modal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="form-transaction" class="p-6 space-y-4">
                <input type="hidden" id="form-type">
                <input type="hidden" id="form-id">
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descri√ß√£o / Origem</label>
                    <input type="text" id="form-desc" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Ex: Sal√°rio, Mercado...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor (R$)</label>
                        <input type="text" id="form-val" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="0,00" oninput="formatCurrencyInput(this)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data</label>
                        <input type="date" id="form-date" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all cursor-pointer" onclick="try{this.showPicker()}catch(e){}">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Banco / Institui√ß√£o</label>
                        <input type="text" id="form-bank" list="bank-list" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Selecione ou digite...">
                        <datalist id="bank-list"></datalist>
                    </div>
                    <div id="field-cat-container" class="md:col-span-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Categoria</label>
                        <input type="text" id="form-cat" list="cat-list" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Selecione ou digite...">
                        <datalist id="cat-list"></datalist>
                    </div>
                    <div id="field-installments-container" class="md:col-span-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Parcelas</label>
                        <input type="number" id="form-installments" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all" placeholder="1" min="1" value="1">
                    </div>
                </div>

                <div id="field-def-container" class="hidden">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Defini√ß√£o (Regra 50/30/20)</label>
                    <select id="form-def" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all cursor-pointer appearance-none">
                        <option value="Necessidades (50%)">Necessidades (50%)</option>
                        <option value="Desejos (30%)">Desejos (30%)</option>
                        <option value="Poupan√ßa/D√≠vidas (20%)">Poupan√ßa/D√≠vidas (20%)</option>
                    </select>
                </div>

                <button type="submit" id="btn-save" class="w-full bg-brand-accent hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all mt-4 transform active:scale-[0.98]">
                    Salvar Registro
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL BACKUP -->
    <div id="backup-modal" class="fixed inset-0 z-[75] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('backup-modal')"></div>
        <div class="relative w-full max-w-2xl glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-display text-xl font-bold text-white">Backup e Restaura√ß√£o</h3>
                <button onclick="closeModal('backup-modal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 flex-1 overflow-auto">
                <p class="text-sm text-slate-400 mb-4">
                    Crie um ponto de restaura√ß√£o com todos os seus dados atuais. Seus dados di√°rios j√° s√£o salvos na nuvem automaticamente.
                </p>
                <div id="backup-status" class="hidden p-4 rounded-lg text-center mb-4"></div>
                
                <h4 class="text-brand-accent font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Backups Salvos</h4>
                <ul id="list-backups" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Lista de backups ser√° populada aqui -->
                    <li class="text-center text-slate-500 py-4">Nenhum backup encontrado.</li>
                </ul>
            </div>

            <div class="p-6 bg-slate-900/50 border-t border-slate-700">
                <button onclick="createBackup()" id="btn-create-backup" class="w-full bg-brand-accent hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i>
                    <span>Criar Novo Backup</span>
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, where, Timestamp, writeBatch, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWA5-o7lvPv7zybt1B-k7HdKcgPNYQOEc",
  authDomain: "planilha-financeira-fca35.firebaseapp.com",
  projectId: "planilha-financeira-fca35",
  storageBucket: "planilha-financeira-fca35.firebasestorage.app",
  messagingSenderId: "768116977602",
  appId: "1:768116977602:web:f40ceaf4e4998352ee305b"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let transactions = [];
        let chartInstances = {};
        
        // Configurable Lists State
        let userSettings = {
            banks: ["Nubank", "Inter", "Ita√∫", "Bradesco", "Caixa", "Santander", "Carteira", "XP", "Binance"],
            categories: ["Moradia", "Alimenta√ß√£o", "Transporte", "Lazer", "Sa√∫de", "Educa√ß√£o", "Investimento", "Assinaturas", "Outros"],
            goalExpense: 80,
            goalSavings: 20
        };

        let investmentGoal = 0;
        let monthlyInvestments = {};

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.isAnonymous ? 'Visitante' : user.displayName.split(' ')[0];
                document.getElementById('user-avatar').src = user.photoURL || "https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff";
                await initSettings();
                loadData();
                loadInvestmentData();
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('login-status').textContent = "";
            }
        });

        document.getElementById('btn-login-google').addEventListener('click', async () => {
            const status = document.getElementById('login-status');
            const errorMsg = document.getElementById('login-error');
            
            try {
                status.textContent = "Conectando ao Google...";
                errorMsg.classList.add('hidden');
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/unauthorized-domain' || error.code === 'auth/operation-not-supported-in-this-environment') {
                    status.textContent = "Ambiente de teste detectado...";
                    errorMsg.textContent = "Dom√≠nio de teste. Entrando como Visitante...";
                    errorMsg.classList.remove('hidden');
                    setTimeout(async () => {
                        try { await signInAnonymously(auth); } catch(e) { errorMsg.textContent = "Erro: " + e.message; }
                    }, 1500);
                } else {
                    status.textContent = "";
                    errorMsg.textContent = "Erro: " + error.message;
                    errorMsg.classList.remove('hidden');
                }
            }
        });

        // CORRE√á√ÉO: Fun√ß√£o renomeada e usando 'auth' do escopo do m√≥dulo
        window.logoutApp = () => signOut(auth);

        // --- SETTINGS MANAGEMENT ---
        async function initSettings() {
            if(!currentUser) return;
            const ref = doc(db, "user_settings", currentUser.uid);
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                const data = snap.data();
                if(data.banks) userSettings.banks = data.banks;
                if(data.categories) userSettings.categories = data.categories;
                if(data.goalExpense) userSettings.goalExpense = data.goalExpense;
                if(data.goalSavings) userSettings.goalSavings = data.goalSavings;
            } else {
                await setDoc(ref, userSettings);
            }
            updateDropdowns();
            
            // Populate Goal Inputs
            const expenseInput = document.getElementById('setting-goal-expense');
            const savingsInput = document.getElementById('setting-goal-savings');
            if(expenseInput) expenseInput.value = userSettings.goalExpense;
            if(savingsInput) savingsInput.value = userSettings.goalSavings;

            setupDropdownBehavior('form-bank');
            setupDropdownBehavior('form-cat');
        }

        async function saveSettings() {
            if(!currentUser) return;
            await setDoc(doc(db, "user_settings", currentUser.uid), userSettings, {merge: true});
            updateDropdowns();
            renderSettingsList();
            updateInterface(); // Refresh dashboard with new goals
        }

        window.openSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsList();
        }

        window.updateGoal = async (key, value) => {
            const val = parseFloat(value);
            if(!isNaN(val) && val >= 0 && val <= 100) {
                userSettings[key] = val;
                await saveSettings();
            }
        }

        window.addSettingItem = async (type, inputId) => {
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if(!val) return;
            if(!userSettings[type].includes(val)) {
                userSettings[type].push(val);
                userSettings[type].sort();
                input.value = '';
                await saveSettings();
            }
        }

        window.removeSettingItem = async (type, val) => {
            if(confirm(`Remover "${val}" da lista?`)) {
                userSettings[type] = userSettings[type].filter(item => item !== val);
                await saveSettings();
            }
        }

        function renderSettingsList() {
            const render = (type, listId) => {
                const ul = document.getElementById(listId);
                ul.innerHTML = '';
                userSettings[type].forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700";
                    li.innerHTML = `
                        <span class="text-sm text-slate-300">${item}</span>
                        <button onclick="removeSettingItem('${type}', '${item}')" class="text-slate-500 hover:text-rose-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    `;
                    ul.appendChild(li);
                });
            };
            render('banks', 'list-banks');
            render('categories', 'list-categories');
        }

        function updateDropdowns() {
            const populate = (id, list) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                list.forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    el.appendChild(opt);
                });
            };
            populate('bank-list', userSettings.banks);
            populate('cat-list', userSettings.categories);
        }
        
        function setupDropdownBehavior(inputId) {
            const input = document.getElementById(inputId);
            let previousValue = "";
            if(!input) return;
            input.addEventListener('focus', () => {
                previousValue = input.value;
                input.value = ''; 
            });
            input.addEventListener('blur', () => {
                if(input.value === '' && previousValue !== '') input.value = previousValue;
            });
            input.addEventListener('input', () => {
                if(input.value !== '') previousValue = input.value;
            });
        }

        function saveInvestmentData() {
            localStorage.setItem('investmentGoal', investmentGoal);
            localStorage.setItem('monthlyInvestments', JSON.stringify(monthlyInvestments));
        }

        function updateInvestmentKPIs() {
            const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            const investmentValues = Object.values(monthlyInvestments);

            // 1. Total Acumulado
            const totalInvestido = investmentValues.reduce((sum, value) => sum + value, 0);
            document.getElementById('kpi-total-investido').textContent = fmt(totalInvestido);

            // 2. M√©dia Mensal
            const count = investmentValues.length;
            const mediaAportes = count > 0 ? totalInvestido / count : 0;
            document.getElementById('kpi-media-aportes').textContent = fmt(mediaAportes);
            
            // 3. Meta do M√™s Atual & Progress Bar
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const aporteMesAtual = monthlyInvestments[currentMonthKey] || 0;
            
            let percMeta = 0;
            if (investmentGoal > 0) {
                percMeta = (aporteMesAtual / investmentGoal) * 100;
            }
            
            document.getElementById('kpi-meta-mes').textContent = `${percMeta.toFixed(1)}%`;
            
            const progressBar = document.getElementById('goal-progress-bar');
            progressBar.style.width = `${Math.min(percMeta, 100)}%`;
            
            if (percMeta >= 100) {
                progressBar.classList.remove('bg-brand-accent');
                progressBar.classList.add('bg-brand-receita');
            } else {
                progressBar.classList.add('bg-brand-accent');
                progressBar.classList.remove('bg-brand-receita');
            }
        }

        function renderInvestmentBarChart() {
            if (chartInstances.investmentBar) {
                chartInstances.investmentBar.destroy();
            }
            const ctx = document.getElementById('investment-bar-chart').getContext('2d');

            const sortedMonths = Object.keys(monthlyInvestments).sort();
            const last6Months = sortedMonths.slice(-6);

            if (last6Months.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.fillText('Nenhum aporte registrado para exibir o gr√°fico.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                ctx.restore();
                return;
            }

            const labels = last6Months.map(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleString('pt-BR', { month: 'short' });
                return `${monthName.toUpperCase()}/${year.slice(2)}`;
            });
            
            const dataRealizado = last6Months.map(month => monthlyInvestments[month]);
            const dataMeta = last6Months.map(() => investmentGoal);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Meta',
                        data: dataMeta,
                        backgroundColor: 'rgba(100, 116, 139, 0.5)',
                        borderColor: 'rgba(100, 116, 139, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    },
                    {
                        label: 'Aporte Realizado',
                        data: dataRealizado,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }
                ]
            };

            chartInstances.investmentBar = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                           display: false
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });
        }

        function loadInvestmentData() {
            const savedGoal = localStorage.getItem('investmentGoal');
            if (savedGoal) {
                investmentGoal = parseFloat(savedGoal);
                document.getElementById('investment-goal').value = investmentGoal.toFixed(2).replace('.', ',');
            }

            const savedMonthlyInvestments = localStorage.getItem('monthlyInvestments');
            if (savedMonthlyInvestments) {
                monthlyInvestments = JSON.parse(savedMonthlyInvestments);
            }
            updateInvestmentHistory();
        }

        // --- DATA LOAD ---
        function loadData() {
            const q = query(collection(db, "transacoes_financeiras"), orderBy("date", "desc"));
            onSnapshot(q, (snap) => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.uid === currentUser.uid);
                updateInterface();
            });
        }

        // --- CURRENCY MASK ---
        window.formatCurrencyInput = (input) => {
            let value = input.value.replace(/\D/g, "");
            value = (Number(value) / 100).toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = value === '0,00' ? '' : value;
        };

        // --- HELPER FOR GRADIENTS ---
        function createGradient(ctx, colorStart, colorEnd) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        // --- DASHBOARD CORE LOGIC ---
function updateInterface() {
    const monthFilter = document.getElementById('filter-month').value;
    const searchFilter = document.getElementById('grid-search').value.toLowerCase();

    let filteredData = transactions;
    if(monthFilter) filteredData = filteredData.filter(t => t.date.startsWith(monthFilter));
    
    const tableData = filteredData.filter(t => 
        (t.title && t.title.toLowerCase().includes(searchFilter)) || 
        (t.category && t.category.toLowerCase().includes(searchFilter)) ||
        (t.bank && t.bank.toLowerCase().includes(searchFilter))
    );

    const receitasTable = tableData.filter(t => t.type === 'receita');
    const despesasTable = tableData.filter(t => t.type === 'despesa');

    // Receitas: 4 colunas de dados + 1 de a√ß√µes = 5 colunas no total
    renderTable('tbody-receitas', receitasTable, ['date', 'title', 'bank', 'value'], 'receita');
    
    // Despesas: 5 colunas de dados + 1 de a√ß√µes = 6 colunas no total
    // A ordem abaixo garante: Data, Descri√ß√£o, Categoria, Caracter√≠stica, Banco, Valor
    renderTable('tbody-despesas', despesasTable, ['date', 'title', 'category', 'definition', 'bank', 'value'], 'despesa');
    
    document.getElementById('tab-badge-rec').textContent = receitasTable.length;
    document.getElementById('tab-badge-desp').textContent = despesasTable.length;

    if(document.getElementById('dashboard-full').style.display !== 'none' || document.getElementById('dashboard-full').classList.contains('active')) {
        window.updateDashboardAnalytics();
    }
}

        window.toggleMerge = () => {
            const btn = document.getElementById('btn-merge');
            const container2 = document.getElementById('container-month-2');
            const isHidden = container2.classList.contains('hidden');
            
            if(isHidden) {
                container2.classList.remove('hidden');
                btn.classList.add('text-brand-accent', 'bg-white/10');
                btn.classList.remove('text-slate-500');
            } else {
                container2.classList.add('hidden');
                btn.classList.remove('text-brand-accent', 'bg-white/10');
                btn.classList.add('text-slate-500');
            }
            window.updateDashboardAnalytics();
        }

        window.updateDashboardAnalytics = () => {
            // Check state
            const isMerge = !document.getElementById('container-month-2').classList.contains('hidden');
            
            let startMonth = document.getElementById('dash-filter-month-1').value;
            let endMonth = isMerge ? document.getElementById('dash-filter-month-2').value : startMonth;

            // Defaults if empty
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            if(!startMonth) {
                startMonth = currentMonthStr;
                document.getElementById('dash-filter-month-1').value = startMonth;
            }
            // If merge is ON but no date selected, default to startMonth
            if(isMerge && !endMonth) {
                endMonth = startMonth;
            }
            // If merge is OFF, force end = start
            if(!isMerge) {
                endMonth = startMonth;
            }

            // Swap if start > end to prevent bugs
            if(startMonth > endMonth) {
                [startMonth, endMonth] = [endMonth, startMonth];
            }
            
            const fmtMoney = (v) => new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(v);

            // Filter by Range (Inclusive)
            const rangeData = transactions.filter(t => {
                const tMonth = t.date.substring(0, 7);
                return tMonth >= startMonth && tMonth <= endMonth;
            });

            // KPIs Calculation (Sum of entire range)
            const totalRec = rangeData.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.value, 0);
            const valExp = rangeData.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.value, 0);
            const balance = totalRec - valExp;
            const valInvest = balance; 

            // Update DOM KPIs
            document.getElementById('dash-rec').textContent = fmtMoney(totalRec);
            document.getElementById('dash-desp').textContent = fmtMoney(valExp);
            document.getElementById('dash-saldo').textContent = fmtMoney(balance);

            // --- 1. Despesas Card Details ---
            const kpiStatus = document.getElementById('kpi-despesa-status');
            const expenseLimitPercent = userSettings.goalExpense || 80;
            const expenseTargetValue = totalRec > 0 ? totalRec * (expenseLimitPercent / 100) : 0;
            const expenseCurrentPercent = expenseTargetValue > 0 ? (valExp / expenseTargetValue) * 100 : 0;

            let expenseColorClass = 'text-brand-receita'; 
            let iconClass = 'fa-check';

            if (valExp > expenseTargetValue) {
                expenseColorClass = 'text-brand-despesa'; 
                iconClass = 'fa-triangle-exclamation';
            } else if (valExp > expenseTargetValue * 0.9) {
                expenseColorClass = 'text-brand-warning'; 
                iconClass = 'fa-circle-exclamation';
            }

            // HTML injection for Despesas
            kpiStatus.innerHTML = `
                <div class="flex flex-col w-full mt-2">
                    <div class="flex justify-between items-center text-[10px] uppercase tracking-wider text-slate-400 mb-1">
                        <span>Meta (${expenseLimitPercent}%)</span>
                        <span>${fmtMoney(expenseTargetValue)}</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mb-1">
                        <div class="bg-current h-1.5 rounded-full ${expenseColorClass}" style="width: ${Math.min(expenseCurrentPercent, 100)}%"></div>
                    </div>
                    <div class="flex justify-between items-center text-[10px]">
                        <span class="${expenseColorClass} font-bold"><i class="fa-solid ${iconClass}"></i> ${expenseCurrentPercent.toFixed(1)}%</span>
                        <span class="text-slate-500">do Limite</span>
                    </div>
                </div>
            `;
            document.getElementById('card-despesa-kpi').className = "glass p-6 rounded-3xl relative overflow-hidden border-transparent transition-all";

            // --- 2. Investimentos (Circle) Card Details ---
            const savingsGoalPercent = userSettings.goalSavings || 20;
            const savingsTargetValue = totalRec > 0 ? totalRec * (savingsGoalPercent / 100) : 0;
            const savingsActualPercent = savingsTargetValue > 0 ? (valInvest / savingsTargetValue) * 100 : 0;
            
            const circle = document.getElementById('circle-progress');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const visualPercent = Math.max(0, Math.min(savingsActualPercent, 100)); 
            const offset = circumference - (visualPercent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            
            if(savingsActualPercent >= 100) circle.style.stroke = '#10b981'; 
            else if(savingsActualPercent >= 50) circle.style.stroke = '#3b82f6'; 
            else circle.style.stroke = '#f59e0b'; 

            document.getElementById('dash-eco-perc').textContent = `${savingsActualPercent.toFixed(1)}%`;

            const invLabel = document.getElementById('label-inv-goal');
            invLabel.innerHTML = `
                <div class="flex flex-col items-center mt-3 w-full">
                    <div class="flex justify-between w-full text-[10px] text-slate-400 uppercase font-bold border-b border-slate-700/50 pb-1 mb-1">
                        <span>Meta (${savingsGoalPercent}%)</span>
                        <span>${fmtMoney(savingsTargetValue)}</span>
                    </div>
                    <div class="flex justify-between w-full text-[10px] font-bold">
                        <span class="text-slate-500">Realizado</span>
                        <span class="${savingsActualPercent >= 100 ? 'text-brand-receita' : 'text-brand-accent'}">${fmtMoney(valInvest)}</span>
                    </div>
                </div>
            `;

            // --- CHARTS UPDATE ---
            updateCharts(rangeData, startMonth, endMonth);
        }

        function updateCharts(rangeData, startMonth, endMonth) {
            const isMerge = !document.getElementById('container-month-2').classList.contains('hidden');
            
            const commonOptions = {
                responsive: true, 
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { labels: { color: '#94a3b8', font: {family: 'Inter'} } },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: '#334155', borderDash: [2, 4] }, 
                        ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#94a3b8' } 
                    }
                }
            };

            const datalabelsPlugin = {
                id: 'datalabels',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx } = chart;
                    ctx.save();
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((element, index) => {
                            if (!element.hidden) {
                                const data = dataset.data[index];
                                if(data !== null && data !== undefined && data !== 0) { 
                                    const valueStr = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits: 0}).format(data);
                                    ctx.font = 'bold 9px Inter';
                                    ctx.fillStyle = '#cbd5e1'; 
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.fillText(valueStr, element.x, element.y - 8);
                                }
                            }
                        });
                    });
                    ctx.restore();
                }
            };

            // --- Chart D: Fluxo Financeiro (Barra/Linha) ---
            // L√≥gica Atualizada: Se !Merge, pegar o ano inteiro. Se Merge, pegar o range.
            let flowData = rangeData;
            let flowStart = startMonth;
            let flowEnd = endMonth;

            if (!isMerge) {
                // Se N√ÉO estiver mesclado, mostrar o ano inteiro (Jan-Dez) do ano selecionado
                const year = startMonth.split('-')[0];
                flowStart = `${year}-01`;
                flowEnd = `${year}-12`;
                
                // Filtra da lista global de transa√ß√µes para pegar o ano todo
                flowData = transactions.filter(t => t.date.startsWith(year));
                
                document.getElementById('title-chart-main').textContent = `Fluxo Anual (${year})`;
                document.getElementById('subtitle-chart-main').textContent = "Janeiro a Dezembro";
            } else {
                document.getElementById('title-chart-main').textContent = "Fluxo do Per√≠odo";
                document.getElementById('subtitle-chart-main').textContent = "Intervalo Personalizado";
            }

            // 1. Generate all month keys between start and end
            const monthKeys = [];
            const [startY, startM] = flowStart.split('-').map(Number);
            const [endY, endM] = flowEnd.split('-').map(Number);
            
            let currY = startY;
            let currM = startM;
            
            let loops = 0;
            while ((currY < endY || (currY === endY && currM <= endM)) && loops < 60) {
                monthKeys.push(`${currY}-${String(currM).padStart(2,'0')}`);
                currM++;
                if (currM > 12) {
                    currM = 1;
                    currY++;
                }
                loops++;
            }

            // 2. Aggregate Data per Key for Flow Chart
            const monthsMap = {};
            monthKeys.forEach(k => monthsMap[k] = { expense: 0, revenue: 0 });

            flowData.forEach(t => {
                const k = t.date.substring(0, 7);
                if(monthsMap[k]) {
                    if(t.type === 'despesa') monthsMap[k].expense += t.value;
                    else if(t.type === 'receita') monthsMap[k].revenue += t.value;
                }
            });

            const dataExp = monthKeys.map(k => monthsMap[k].expense);
            const dataInv = monthKeys.map(k => Math.max(0, monthsMap[k].revenue - monthsMap[k].expense));
            
            // Generate friendly labels (e.g., JAN/24)
            const labelsMain = monthKeys.map(k => {
                const [y, m] = k.split('-');
                const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
                return `${monthNames[parseInt(m)-1]}/${y.slice(2)}`;
            });

            if(chartInstances.main) chartInstances.main.destroy();
            
            const ctxMain = document.getElementById('chart-main').getContext('2d');
            const goldGradient = createGradient(ctxMain, 'rgba(251, 191, 36, 0.7)', 'rgba(251, 191, 36, 0.0)');
            const darkGradient = createGradient(ctxMain, 'rgba(71, 85, 105, 1)', 'rgba(30, 41, 59, 0.6)');

            chartInstances.main = new Chart(ctxMain, {
                type: 'bar',
                plugins: [datalabelsPlugin],
                data: {
                    labels: labelsMain,
                    datasets: [
                        {
                            label: 'Saldo/Invest.',
                            data: dataInv,
                            type: 'line',
                            borderColor: '#fbbf24',
                            backgroundColor: goldGradient,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointBackgroundColor: '#fbbf24',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            label: 'Despesas',
                            data: dataExp,
                            backgroundColor: darkGradient,
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderWidth: 1,
                            borderRadius: 2, 
                            yAxisID: 'y',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: {family: 'Inter', size: 11}, usePointStyle: true, boxWidth: 8 } 
                        },
                        tooltip: commonOptions.plugins.tooltip
                    },
                    scales: {
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#334155', borderDash: [2, 4] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#fbbf24', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });

            // NEW Chart: Top Categories (Restored as Bar) - ID: chart-top-cat
            const expenses = rangeData.filter(t => t.type === 'despesa');
            const catMap = {};
            expenses.forEach(t => {
                const cat = t.category || 'Outros'; 
                catMap[cat] = (catMap[cat] || 0) + t.value;
            });
            const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 6);

            if(chartInstances.topCat) chartInstances.topCat.destroy();
            
            const ctxTopCat = document.getElementById('chart-top-cat').getContext('2d');
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#64748b'];
            const gradients = colors.map(c => {
                const grad = ctxTopCat.createLinearGradient(0, 0, 0, 300);
                grad.addColorStop(0, c); 
                grad.addColorStop(1, c + '1A'); 
                return grad;
            });

            chartInstances.topCat = new Chart(ctxTopCat, {
                type: 'bar',
                data: {
                    labels: sortedCats.map(x => x[0]),
                    datasets: [{
                        label: 'Gasto',
                        data: sortedCats.map(x => x[1]),
                        backgroundColor: gradients,
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: commonOptions.plugins.tooltip
                    },
                    scales: {
                        y: { 
                            grid: { color: '#334155', borderDash: [2, 4] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });

// Chart A: Timeline Detail (Yellow Line)
            // L√≥gica: Filtra, agrupa por categoria e soma os valores
            const timelineExpensesRaw = rangeData.filter(t => t.type === 'despesa');
            
            // Agrupamento e Soma por Categoria
            const groupedMap = timelineExpensesRaw.reduce((acc, t) => {
                const cat = t.category || 'Outros';
                acc[cat] = (acc[cat] || 0) + t.value;
                return acc;
            }, {});

            // Ordena√ß√£o por valor decrescente (ajuda na leitura do gr√°fico de linha)
            const sortedEntries = Object.entries(groupedMap).sort((a, b) => b[1] - a[1]);

            const labelsLine = sortedEntries.map(entry => entry[0]);
            const dataLine = sortedEntries.map(entry => entry[1]);
            const totalLine = dataLine.reduce((a, b) => a + b, 0);

            const fmt = new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('chart-timeline-total').textContent = `Total do per√≠odo: ${fmt.format(totalLine)}`;

            if(chartInstances.timeline) chartInstances.timeline.destroy();
            
            const ctxTimeline = document.getElementById('chart-timeline').getContext('2d');
            const timelineGradient = createGradient(ctxTimeline, 'rgba(251, 191, 36, 0.5)', 'rgba(251, 191, 36, 0.0)');

            chartInstances.timeline = new Chart(ctxTimeline, {
                type: 'line',
                plugins: [datalabelsPlugin], 
                data: {
                    labels: labelsLine,
                    datasets: [{
                        label: 'Valor',
                        data: dataLine,
                        borderColor: '#facc15', // Yellow-400
                        backgroundColor: timelineGradient,
                        borderWidth: 2,
                        tension: 0.4, 
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#facc15',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return fmt.format(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: '#334155', borderDash: [5, 5] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 30 } 
                        }
                    }
                }
            });

            // Chart B: Gastos por Banco (Per√≠odo)
            const bankMap = {};
            rangeData.filter(t => t.type === 'despesa').forEach(t => {
                const b = t.bank || 'Carteira';
                bankMap[b] = (bankMap[b] || 0) + t.value;
            });
            const sortedBanks = Object.entries(bankMap).sort((a,b) => b[1] - a[1]);

            if(chartInstances.bank) chartInstances.bank.destroy();
            
            const ctxBank = document.getElementById('chart-bank').getContext('2d');
            const bankGradient = createGradient(ctxBank, 'rgba(59, 130, 246, 0.8)', 'rgba(59, 130, 246, 0.1)'); // Blue

            chartInstances.bank = new Chart(ctxBank, {
                type: 'bar',
                data: {
                    labels: sortedBanks.map(x => x[0]),
                    datasets: [{
                        label: 'Total',
                        data: sortedBanks.map(x => x[1]),
                        backgroundColor: bankGradient,
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: {weight: 'bold'} } }
                    }
                }
            });

            // Chart E: Ranking de Receitas (Per√≠odo)
            document.getElementById('title-chart-type').textContent = "Fontes de Receita";
            
            const recMap = {};
            rangeData.filter(t => t.type === 'receita').forEach(t => {
                const o = t.origin || t.title || 'Diversos';
                recMap[o] = (recMap[o] || 0) + t.value;
            });
            const sortedRec = Object.entries(recMap).sort((a,b) => b[1] - a[1]).slice(0, 5);

            if(chartInstances.type) chartInstances.type.destroy();
            
            const ctxType = document.getElementById('chart-type').getContext('2d');
            const recGradient = createGradient(ctxType, 'rgba(16, 185, 129, 0.8)', 'rgba(16, 185, 129, 0.1)'); // Green

            chartInstances.type = new Chart(ctxType, {
                type: 'bar', // Horizontal Bar
                data: {
                    labels: sortedRec.map(x => x[0]),
                    datasets: [{
                        label: 'Entrada',
                        data: sortedRec.map(x => x[1]),
                        backgroundColor: recGradient,
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: {weight: 'bold'} } }
                    }
                }
            });
        }

        function renderTable(elementId, data, cols, type) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            
            data.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "table-row-hover border-b border-slate-800 transition-colors";
                
                let html = '';
                cols.forEach(col => {
                    if(col === 'date') html += `<td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-slate-500">${formatDate(t.date)}</td>`;
                    else if(col === 'value') {
                        const color = type === 'receita' ? 'text-brand-receita' : 'text-brand-despesa';
                        const sign = type === 'receita' ? '+' : '-';
                        const formattedValue = t.value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        html += `<td class="px-6 py-4 text-right font-bold ${color}">${sign} ${formattedValue}</td>`;
                    }
                    else if(col === 'category' || col === 'definition') {
                        html += `<td class="px-6 py-4"><span class="bg-slate-800 border border-slate-700 text-xs px-2 py-1 rounded text-slate-300">${t[col] || '-'}</span></td>`;
                    }
                    else html += `<td class="px-6 py-4 font-medium text-slate-300">${t[col] || '-'}</td>`;
                });

                html += `<td class="px-6 py-4 text-center">
                    <button onclick="editItem('${t.id}')" class="text-slate-500 hover:text-brand-accent transition-colors mr-3" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                    <button onclick="deleteItem('${t.id}')" class="text-slate-600 hover:text-brand-despesa transition-colors" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                </td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        window.deleteItem = async (id) => {
            if(confirm('Tem certeza?')) await deleteDoc(doc(db, "transacoes_financeiras", id));
        }

        window.editItem = (id) => {
            const item = transactions.find(t => t.id === id);
            if(!item) return;

            openModal(item.type);
            
            document.getElementById('form-id').value = item.id;
            document.getElementById('form-desc').value = item.title;
            
            const valStr = (item.value * 100).toString(); 
            const inputVal = document.getElementById('form-val');
            inputVal.value = valStr; 
            formatCurrencyInput(inputVal);

            document.getElementById('form-date').value = item.date;
            document.getElementById('form-bank').value = item.bank;

            if(item.type === 'despesa') {
                document.getElementById('form-cat').value = item.category;
                document.getElementById('form-def').value = item.definition;
                document.getElementById('field-installments-container').classList.add('hidden');
            }

            document.getElementById('modal-title').textContent = `Editar ${item.type === 'receita' ? 'Receita' : 'Despesa'}`;
            document.getElementById('btn-save').textContent = 'Atualizar Registro';
        }

        document.getElementById('grid-search').addEventListener('input', updateInterface);
        document.getElementById('filter-month').addEventListener('change', updateInterface);
        document.getElementById('dash-filter-month-1').addEventListener('change', (e) => window.updateDashboardAnalytics());
        document.getElementById('dash-filter-month-2').addEventListener('change', (e) => window.updateDashboardAnalytics());

        window.clearAllData = async () => {
            if(!confirm("CUIDADO: Isso apagar√° tudo!")) return;
            const batch = writeBatch(db);
            transactions.forEach(t => batch.delete(doc(db, "transacoes_financeiras", t.id)));
            await batch.commit();
        }

        // --- NAVIGATION & MODALS ---
        window.switchView = (viewName) => {
            ['home', 'datagrid', 'investimentos'].forEach(v => {
                const viewEl = document.getElementById(`view-${v}`);
                if(viewEl) viewEl.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            ['home', 'datagrid', 'investimentos'].forEach(v => {
                 const navEl = document.getElementById(`nav-${v}`);
                 if(navEl) {
                    navEl.classList.remove('text-brand-accent', 'bg-slate-800/50');
                    navEl.classList.add('text-slate-400');
                 }
            });
            
            document.getElementById(`nav-${viewName}`).classList.add('text-brand-accent', 'bg-slate-800/50');
            document.getElementById(`nav-${viewName}`).classList.remove('text-slate-400');
        }

        window.switchTableTab = (tab) => {
            if(tab === 'receitas') {
                document.getElementById('tab-content-receitas').classList.remove('hidden');
                document.getElementById('tab-content-despesas').classList.add('hidden');
                document.getElementById('tab-btn-receitas').classList.add('border-brand-receita', 'text-brand-receita');
                document.getElementById('tab-btn-receitas').classList.remove('border-transparent', 'text-slate-500');
                document.getElementById('tab-btn-despesas').classList.add('border-transparent', 'text-slate-500');
                document.getElementById('tab-btn-despesas').classList.remove('border-brand-despesa', 'text-brand-despesa');
            } else {
                document.getElementById('tab-content-receitas').classList.add('hidden');
                document.getElementById('tab-content-despesas').classList.remove('hidden');
                document.getElementById('tab-btn-despesas').classList.add('border-brand-despesa', 'text-brand-despesa'); 
                document.getElementById('tab-btn-despesas').classList.remove('border-transparent', 'text-slate-500');
                document.getElementById('tab-btn-receitas').classList.add('border-transparent', 'text-slate-500');
                document.getElementById('tab-btn-receitas').classList.remove('border-brand-receita', 'text-brand-receita');
            }
        }

        window.openDashboardFull = () => {
            document.getElementById('dashboard-full').classList.add('active');
            updateInterface(); 
        }
        window.closeDashboardFull = () => document.getElementById('dashboard-full').classList.remove('active');

        window.openModal = (type) => {
            const modal = document.getElementById('modal');
            if(modal) {
                modal.classList.remove('hidden');
                document.getElementById('form-id').value = ''; 
                document.getElementById('form-type').value = type;
                document.getElementById('modal-title').textContent = type === 'receita' ? 'Nova Receita' : 'Nova Despesa';
                document.getElementById('modal-title').className = `font-display text-xl font-bold ${type === 'receita' ? 'text-brand-receita' : 'text-brand-despesa'}`;
                
                const btnSave = document.getElementById('btn-save');
                btnSave.textContent = 'Salvar Registro';
                btnSave.className = `w-full font-bold py-4 rounded-xl shadow-lg transition-all mt-4 text-white ${type === 'receita' ? 'bg-brand-receita hover:bg-emerald-600 shadow-emerald-500/20' : 'bg-brand-despesa hover:bg-rose-600 shadow-rose-500/20'}`;
                
                if(type === 'receita') {
                    document.getElementById('field-cat-container').classList.add('hidden');
                    document.getElementById('field-def-container').classList.add('hidden');
                    document.getElementById('field-installments-container').classList.add('hidden');
                } else {
                    document.getElementById('field-cat-container').classList.remove('hidden');
                    document.getElementById('field-def-container').classList.remove('hidden');
                    document.getElementById('field-installments-container').classList.remove('hidden');
                }
                
                if(!document.getElementById('form-id').value) {
                    document.getElementById('form-transaction').reset();
                    document.getElementById('form-type').value = type;
                    document.getElementById('form-date').valueAsDate = new Date();
                }
            }
        }
        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- BACKUP AND RESTORE ---
        window.openBackupModal = () => {
            document.getElementById('backup-modal').classList.remove('hidden');
            loadBackups();
        }

        async function loadBackups() {
            if (!currentUser) return;
            const backupList = document.getElementById('list-backups');
            backupList.innerHTML = '<li class="text-center text-slate-500 py-4">Carregando backups...</li>';

            const q = query(collection(db, "backups"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);

            if (snap.empty) {
                backupList.innerHTML = '<li class="text-center text-slate-500 py-4">Nenhum backup encontrado.</li>';
                return;
            }

            backupList.innerHTML = '';
            snap.docs.forEach(doc => {
                const backup = doc.data();
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-slate-800/50 p-3 rounded border border-slate-700";
                
                const date = backup.createdAt.toDate();
                const formattedDate = `${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`;

                li.innerHTML = `
                    <div>
                        <p class="font-bold text-sm text-white">Backup de ${formattedDate}</p>
                        <p class="text-xs text-slate-400">${backup.transactionCount} transa√ß√µes</p>
                    </div>
                    <div>
                        <button onclick="restoreBackup('${doc.id}')" class="text-slate-400 hover:text-brand-receita text-xs font-bold py-1 px-3 rounded bg-slate-700 hover:bg-slate-600 transition-colors mr-2">Restaurar</button>
                        <button onclick="deleteBackup('${doc.id}')" class="text-slate-500 hover:text-rose-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                backupList.appendChild(li);
            });
        }

        window.createBackup = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('btn-create-backup');
            const status = document.getElementById('backup-status');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Criando backup...</span>';
            status.classList.add('hidden');

            try {
                // 1. Fetch all current transactions (we already have them in `transactions` array)
                const dataToBackup = transactions.map(({ id, ...rest }) => rest); // Remove live IDs

                // 2. Create new backup document
                await addDoc(collection(db, "backups"), {
                    uid: currentUser.uid,
                    createdAt: Timestamp.now(),
                    transactionCount: dataToBackup.length,
                    data: dataToBackup
                });
                
                status.className = 'p-4 rounded-lg text-center mb-4 bg-brand-receita/20 text-brand-receita';
                status.textContent = 'Backup criado com sucesso!';
                status.classList.remove('hidden');

                loadBackups();

            } catch (error) {
                console.error("Erro ao criar backup:", error);
                status.className = 'p-4 rounded-lg text-center mb-4 bg-brand-despesa/20 text-brand-despesa';
                status.textContent = `Erro ao criar backup: ${error.message}`;
                status.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus-circle"></i> <span>Criar Novo Backup</span>';
            }
        }

        window.deleteBackup = async (backupId) => {
            if (confirm('Tem certeza que deseja apagar este backup? Esta a√ß√£o n√£o pode ser desfeita.')) {
                await deleteDoc(doc(db, "backups", backupId));
                loadBackups();
            }
        }

        window.restoreBackup = async (backupId) => {
            const promptAnswer = prompt("Para restaurar, todos os dados atuais ser√£o APAGADOS. Digite 'RESTAURAR' para confirmar.");
            if (promptAnswer !== 'RESTAURAR') {
                alert('Restaura√ß√£o cancelada.');
                return;
            }

            const status = document.getElementById('backup-status');
            status.textContent = 'Iniciando restaura√ß√£o...';
            status.className = 'p-4 rounded-lg text-center mb-4 bg-brand-warning/20 text-brand-warning';
            status.classList.remove('hidden');

            try {
                // 1. Get the backup data
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) throw new Error("Documento de backup n√£o encontrado.");
                const backupData = backupDoc.data().data;

                // 2. Delete all current transactions
                status.textContent = 'Apagando dados atuais...';
                const batchDelete = writeBatch(db);
                transactions.forEach(t => {
                    batchDelete.delete(doc(db, "transacoes_financeiras", t.id));
                });
                await batchDelete.commit();

                // 3. Add transactions from backup
                status.textContent = 'Restaurando dados do backup...';
                const batchRestore = writeBatch(db);
                backupData.forEach(t => {
                    // Ensure createdAt is a Timestamp if it exists, otherwise add it
                    const newDoc = {
                        ...t,
                        createdAt: t.createdAt?.toDate ? t.createdAt : Timestamp.now()
                    };
                    batchRestore.set(doc(collection(db, "transacoes_financeiras")), newDoc);
                });
                await batchRestore.commit();
                
                status.className = 'p-4 rounded-lg text-center mb-4 bg-brand-receita/20 text-brand-receita';
                status.textContent = 'Restaura√ß√£o conclu√≠da com sucesso! Os dados ser√£o recarregados.';
                
                // The onSnapshot listener will automatically refresh the UI.

            } catch (error) {
                console.error("Erro ao restaurar backup:", error);
                status.className = 'p-4 rounded-lg text-center mb-4 bg-brand-despesa/20 text-brand-despesa';
                status.textContent = `Erro na restaura√ß√£o: ${error.message}`;
            }
        }

        window.saveInvestmentGoal = () => {
            const goalValue = document.getElementById('investment-goal').value;
            investmentGoal = parseFloat(goalValue.replace(/\./g, '').replace(',', '.'));
            saveInvestmentData();
            alert(`Meta de investimento salva: R$ ${goalValue}`);
            updateInvestmentHistory();
        }

        window.saveMonthlyInvestment = () => {
            const month = document.getElementById('investment-month').value;
            const amountValue = document.getElementById('investment-amount').value;
            const amount = parseFloat(amountValue.replace(/\./g, '').replace(',', '.'));

            if (month && amount) {
                monthlyInvestments[month] = amount;
                saveInvestmentData();
                alert(`Investimento de R$ ${amountValue} registrado para o m√™s ${month}`);
                updateInvestmentHistory();
            } else {
                alert('Por favor, selecione o m√™s e o valor do investimento.');
            }
        }

        function updateInvestmentHistory() {
            const historyBody = document.getElementById('investment-history-body');
            historyBody.innerHTML = '';

            const sortedMonths = Object.keys(monthlyInvestments).sort((a, b) => b.localeCompare(a));

            for (const month of sortedMonths) {
                const amount = monthlyInvestments[month];
                const goal = investmentGoal;

                const tr = document.createElement('tr');
                tr.className = "table-row-hover border-b border-slate-800 transition-colors";

                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleString('pt-BR', { month: 'short' }).toUpperCase();
                const formattedMonth = `${monthName}/${year.slice(2)}`;

                let html = `
                    <td class="px-6 py-3 whitespace-nowrap font-mono text-sm text-slate-400">${formattedMonth}</td>
                    <td class="px-6 py-3 text-right font-bold text-brand-receita">${amount.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-3 text-right text-slate-500">${goal > 0 ? goal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td class="px-6 py-3 text-center">
                        <button onclick="deleteMonthlyInvestment('${month}')" class="text-slate-600 hover:text-brand-despesa transition-colors" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;

                tr.innerHTML = html;
                historyBody.appendChild(tr);
            }
            updateInvestmentKPIs();
            renderInvestmentBarChart();
        }

        window.deleteMonthlyInvestment = (month) => {
            if (confirm(`Tem certeza que deseja excluir o investimento do m√™s ${month}?`)) {
                delete monthlyInvestments[month];
                saveInvestmentData();
                updateInvestmentHistory();
            }
        }

        document.getElementById('form-transaction').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('form-type').value;
            const id = document.getElementById('form-id').value;
            const valStr = document.getElementById('form-val').value;
            const totalValue = parseFloat(valStr.replace(/\./g, '').replace(',', '.'));

            if (id) {
                const data = {
                    uid: currentUser.uid,
                    type: type,
                    title: document.getElementById('form-desc').value,
                    value: totalValue,
                    date: document.getElementById('form-date').value,
                    bank: document.getElementById('form-bank').value,
                };
                if(type === 'despesa') {
                    data.category = document.getElementById('form-cat').value;
                    data.definition = document.getElementById('form-def').value;
                } else {
                    data.origin = data.title; 
                }
                await updateDoc(doc(db, "transacoes_financeiras", id), data);
            } else {
                const installments = parseInt(document.getElementById('form-installments').value) || 1;
                const installmentValue = installments > 0 ? totalValue / installments : totalValue;
                const originalDesc = document.getElementById('form-desc').value;
                const formDate = document.getElementById('form-date').value;
                const dateParts = formDate.split('-');
                const startDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

                const batch = writeBatch(db);

                for (let i = 0; i < installments; i++) {
                    const targetYear = startDate.getFullYear() + Math.floor((startDate.getMonth() + i) / 12);
                    const targetMonth = (startDate.getMonth() + i) % 12;
                    const originalDay = startDate.getDate();
                    const lastDayOfTargetMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                    const finalDay = Math.min(originalDay, lastDayOfTargetMonth);
                    const installmentDate = new Date(targetYear, targetMonth, finalDay);
                    
                    const data = {
                        uid: currentUser.uid,
                        type: type,
                        title: installments > 1 ? `${originalDesc} (${i + 1}/${installments})` : originalDesc,
                        value: installmentValue,
                        date: installmentDate.toISOString().split('T')[0],
                        bank: document.getElementById('form-bank').value,
                        createdAt: Timestamp.now()
                    };

                    if(type === 'despesa') {
                        data.category = document.getElementById('form-cat').value;
                        data.definition = document.getElementById('form-def').value;
                    } else {
                        data.origin = data.title; 
                    }
                    
                    const docRef = doc(collection(db, "transacoes_financeiras"));
                    batch.set(docRef, data);
                }
                await batch.commit();
            }
            
            closeModal('modal');
            document.getElementById('form-transaction').reset();
        });

        // --- IMPORT EXCEL ---
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const status = document.getElementById('import-status');
            status.textContent = "Processando...";
            status.className = "text-xs text-brand-accent mt-1 animate-pulse";

            const reader = new FileReader();
            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, {type: 'array'});
                const batch = writeBatch(db);
                let count = 0;

                workbook.SheetNames.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    rows.forEach(row => {
                        const keys = Object.keys(row).reduce((acc, k) => { 
                            const cleanKey = k.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                            acc[cleanKey] = row[k]; 
                            return acc; 
                        }, {});

                        let type = 'despesa';
                        if(keys['origem'] || sheetName.toLowerCase().includes('receita')) type = 'receita';

                        const val = parseValue(keys['valor'] || keys['quantia'] || keys['total'] || keys['saida'] || keys['entrada']);
                        const date = parseDate(keys['data'] || keys['dia']);
                        
                        if(val > 0 && date) {
                            const docData = {
                                uid: currentUser.uid,
                                type: type,
                                value: val,
                                date: date,
                                bank: keys['banco'] || keys['instituicao bancaria'] || keys['conta'] || 'N√£o informado',
                                title: keys['descricao'] || keys['origem'] || 'Sem t√≠tulo',
                                createdAt: Timestamp.now()
                            };

                            if(type === 'despesa') {
                                docData.category = keys['categoria'] || keys['despesa'] || 'Outros';
                                docData.definition = keys['definicao'] || keys['tipo'] || 'Outros';
                            } else {
                                docData.origin = keys['origem'] || keys['descricao'];
                            }

                            batch.set(doc(collection(db, "transacoes_financeiras")), docData);
                            count++;
                        }
                    });
                });

                if(count > 0) await batch.commit();
                status.textContent = `${count} itens importados!`;
                status.className = "text-xs text-brand-receita mt-1";
                setTimeout(() => status.textContent = "Clique para carregar planilha", 3000);
            };
            reader.readAsArrayBuffer(file);
        });

        function parseValue(v) {
            if (typeof v === 'number') return v;
            if (!v) return 0;
            let str = v.toString().trim();
            if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.slice(1, -1);
            str = str.replace(/[R$\s\.]/g, '').replace(',', '.');
            const parsed = parseFloat(str);
            return isNaN(parsed) ? 0 : parsed;
        }

        function parseDate(d) {
            if(!d) return new Date().toISOString().split('T')[0];
            if(typeof d === 'number') {
                const date = new Date(Math.round((d - 25569)*86400*1000));
                return date.toISOString().split('T')[0];
            }
            if(d.includes('/')) {
                const p = d.split('/');
                if(p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`;
            }
            return d;
        }
        function formatDate(d) {
            const p = d.split('-');
            return `${p[2]}/${p[1]}/${p[0]}`;
        }
        
        const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('filter-month').value = currentMonth;

    </script>
</body>
</html>"

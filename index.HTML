<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Premium | React</title>
    
    <!-- Fonts: Clash Display & Satoshi (Fontshare) + Inter -->
    <link href="https://api.fontshare.com/v2/css?f[]=clash-display@500,600,700&f[]=satoshi@400,500,700,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome (Fallback/Extras) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Satoshi"', 'sans-serif'],
                        display: ['"Clash Display"', 'sans-serif'],
                        mono: ['"Inter"', 'monospace'], // Usando Inter para números tabulares
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                        // Custom Brand Colors
                        brand: {
                            dark: '#020617', // Slate 950
                            receita: '#10b981',
                            despesa: '#ef4444',
                        }
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    animation: {
                        "accordion-down": "accordion-down 0.2s ease-out",
                        "accordion-up": "accordion-up 0.2s ease-out",
                    },
                }
            }
        }
    </script>
    <style>
        /* CSS Variables for shadcn/ui theme (Dark Mode Native) */
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%;
            --radius: 0.75rem;
        }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-feature-settings: "tnum"; /* Tabular numbers for finance */
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: hsl(var(--muted)); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: hsl(var(--muted-foreground)); }

        /* Spline Viewer Styling */
        spline-viewer {
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Libraries via CDN -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Spline 3D -->
    <script type="module" src="https://unpkg.com/@splinetool/viewer@1.0.94/build/spline-viewer.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN REACT APP -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, where, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBWA5-o7lvPv7zybt1B-k7HdKcgPNYQOEc",
            authDomain: "planilha-financeira-fca35.firebaseapp.com",
            projectId: "planilha-financeira-fca35",
            storageBucket: "planilha-financeira-fca35.firebasestorage.app",
            messagingSenderId: "768116977602",
            appId: "1:768116977602:web:c824c055bf6f578eee305b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILS & HOOKS ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- ICONS ---
        // Using Lucide global object
        const Icon = ({ name, size = 24, className }) => {
            const lucideIcon = window.lucide && window.lucide.icons ? window.lucide.icons[name] : null;
            if (!lucideIcon) return <i className={`fa-solid fa-${name} ${className}`}></i>; // Fallback
            
            // Render Lucide SVG manually since we are in CDN land
            // Simplified: Lucide CDN injects createIcons, but for React component usage it's tricky.
            // We will use FontAwesome for simplicity in this CDN setup unless we use lucide-react UMD which is rare.
            // Actually, let's stick to FontAwesome for reliability in this specific single-file setup, 
            // but styled to look like Lucide (thin, clean).
            return <i className={`fa-solid fa-${name} ${className}`} style={{fontSize: size}}></i>;
        };

        // --- UI COMPONENTS (SHADCN STYLE) ---
        const cn = (...classes) => classes.filter(Boolean).join(" ");

        const Button = ({ children, className, variant = "default", size = "default", ...props }) => {
            const variants = {
                default: "bg-primary text-primary-foreground hover:bg-primary/90",
                destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline",
            };
            const sizes = {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8",
                icon: "h-10 w-10",
            };
            return (
                <motion.button 
                    whileTap={{ scale: 0.95 }}
                    className={cn(
                        "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
                        variants[variant],
                        sizes[size],
                        className
                    )}
                    {...props}
                >
                    {children}
                </motion.button>
            );
        };

        const Card = ({ className, children }) => (
            <div className={cn("rounded-xl border bg-card text-card-foreground shadow-sm", className)}>
                {children}
            </div>
        );

        const Input = ({ className, ...props }) => (
            <input
                className={cn(
                    "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
                    className
                )}
                {...props}
            />
        );

        const Badge = ({ children, variant = "default", className }) => {
            const variants = {
                default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
                secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
                destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
                outline: "text-foreground",
                success: "border-transparent bg-emerald-500/15 text-emerald-500 hover:bg-emerald-500/25",
                danger: "border-transparent bg-rose-500/15 text-rose-500 hover:bg-rose-500/25",
            };
            return (
                <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2", variants[variant], className)}>
                    {children}
                </div>
            );
        }

        // --- SUB-COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const handleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login failed", error);
                }
            };

            return (
                <div className="relative min-h-screen flex items-center justify-center overflow-hidden bg-slate-950">
                    {/* Background Mesh Gradients */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                        <div className="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-blue-600/20 blur-[120px] animate-pulse"></div>
                        <div className="absolute top-[40%] -right-[10%] w-[40%] h-[60%] rounded-full bg-indigo-600/10 blur-[100px]"></div>
                        <div className="absolute -bottom-[10%] left-[20%] w-[30%] h-[40%] rounded-full bg-emerald-500/10 blur-[100px]"></div>
                    </div>

                    <motion.div 
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.8, ease: "easeOut" }}
                        className="relative z-10 w-full max-w-md p-8"
                    >
                        <Card className="p-8 backdrop-blur-xl bg-card/50 border-white/10 shadow-2xl">
                            <div className="flex flex-col items-center text-center space-y-6">
                                <div className="w-20 h-20 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                    <Icon name="wallet" size={32} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="font-display text-4xl font-bold tracking-tight">Financeiro Pro</h1>
                                    <p className="text-muted-foreground mt-2 text-sm">Gestão de patrimônio inteligente.</p>
                                </div>
                                <Button onClick={handleLogin} size="lg" className="w-full h-12 text-base shadow-xl shadow-primary/20">
                                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5 mr-3" />
                                    Entrar com Google
                                </Button>
                            </div>
                        </Card>
                    </motion.div>
                    
                    {/* Spline 3D Placeholder (Floating Element) */}
                    <div className="absolute right-10 bottom-10 w-64 h-64 opacity-50 pointer-events-none hidden lg:block">
                         <spline-viewer url="https://prod.spline.design/6Wq1Q7YGyM-iab9i/scene.splinecode"></spline-viewer>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ transactions }) => {
            // Logic
            const kpis = useMemo(() => {
                const rec = transactions.filter(t => t.type === 'receita').reduce((a, b) => a + b.value, 0);
                const desp = transactions.filter(t => t.type === 'despesa').reduce((a, b) => a + b.value, 0);
                return {
                    receita: rec,
                    despesa: desp,
                    saldo: rec - desp,
                    poupanca: rec > 0 ? ((rec - desp) / rec) * 100 : 0
                };
            }, [transactions]);

            const chartRef = useRef(null);

            useEffect(() => {
                // Simple ChartJS setup
                if (chartRef.current) {
                    // Logic to build chart from transactions...
                    // For brevity in this demo, strictly setting up structure
                }
            }, [transactions]);

            const fmt = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

            return (
                <div className="space-y-6 animate-accordion-down">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard title="Saldo Total" value={fmt(kpis.saldo)} icon="wallet" color="text-white" sub="Disponível" />
                        <KpiCard title="Receitas" value={fmt(kpis.receita)} icon="arrow-up" color="text-brand-receita" sub="Entradas do mês" />
                        <KpiCard title="Despesas" value={fmt(kpis.despesa)} icon="arrow-down" color="text-brand-despesa" sub="Saídas do mês" />
                        <KpiCard title="Taxa Poupança" value={`${kpis.poupanca.toFixed(0)}%`} icon="piggy-bank" color="text-blue-400" sub="Meta: 20%" />
                    </div>

                    {/* Bento Grid Layout */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Main Chart Area */}
                        <Card className="lg:col-span-2 p-6 bg-card/50 backdrop-blur-sm border-white/5 h-[400px] flex flex-col">
                            <h3 className="font-display text-lg font-semibold mb-6">Fluxo de Caixa</h3>
                            <div className="flex-1 w-full bg-slate-900/50 rounded-lg flex items-center justify-center border border-white/5 relative overflow-hidden group">
                                <p className="text-muted-foreground text-sm z-10">Gráfico Interativo (Chart.js)</p>
                                <div className="absolute inset-0 opacity-20 group-hover:opacity-30 transition-opacity">
                                     {/* Fake Chart Bars for Visual */}
                                     <div className="flex items-end justify-around h-full pb-4 px-4 gap-2">
                                        {[40, 60, 30, 80, 50, 90, 40, 60, 30, 80, 50, 70].map((h, i) => (
                                            <motion.div 
                                                key={i}
                                                initial={{ height: 0 }}
                                                animate={{ height: `${h}%` }}
                                                transition={{ delay: i * 0.05 }}
                                                className="w-full bg-primary rounded-t-sm"
                                            />
                                        ))}
                                     </div>
                                </div>
                            </div>
                        </Card>

                        {/* Recent Transactions / Categories */}
                        <Card className="p-6 bg-card/50 backdrop-blur-sm border-white/5 h-[400px] flex flex-col">
                            <h3 className="font-display text-lg font-semibold mb-4">Últimas Atividades</h3>
                            <div className="flex-1 overflow-auto space-y-4 pr-2">
                                {transactions.slice(0, 6).map(t => (
                                    <div key={t.id} className="flex items-center justify-between group cursor-pointer p-2 hover:bg-white/5 rounded-lg transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className={cn("w-10 h-10 rounded-full flex items-center justify-center text-lg", t.type === 'receita' ? 'bg-emerald-500/20 text-emerald-500' : 'bg-rose-500/20 text-rose-500')}>
                                                <Icon name={t.type === 'receita' ? 'arrow-up' : 'arrow-down'} size={14} />
                                            </div>
                                            <div>
                                                <p className="font-bold text-sm text-foreground">{t.title}</p>
                                                <p className="text-xs text-muted-foreground">{t.category || 'Geral'}</p>
                                            </div>
                                        </div>
                                        <span className={cn("font-mono font-medium text-sm", t.type === 'receita' ? 'text-emerald-500' : 'text-rose-500')}>
                                            {t.type === 'receita' ? '+' : '-'} {fmt(t.value)}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        const KpiCard = ({ title, value, icon, color, sub }) => (
            <Card className="p-6 bg-card/50 backdrop-blur-sm border-white/5 hover:border-primary/50 transition-colors cursor-default group relative overflow-hidden">
                <div className="absolute right-0 top-0 w-24 h-24 bg-gradient-to-br from-white/5 to-transparent rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                <div className="flex justify-between items-start mb-2 relative z-10">
                    <p className="text-xs font-bold text-muted-foreground uppercase tracking-wider">{title}</p>
                    <Icon name={icon} className={cn("opacity-70", color)} size={16} />
                </div>
                <div className="relative z-10">
                    <h3 className={cn("text-3xl font-display font-bold mt-1", color)}>{value}</h3>
                    <p className="text-xs text-muted-foreground mt-1">{sub}</p>
                </div>
            </Card>
        );

        const Datagrid = ({ transactions, onDelete }) => {
            const [filter, setFilter] = useState('');
            const [tab, setTab] = useState('receita'); // receita | despesa

            const filtered = transactions.filter(t => 
                t.type === tab && 
                (t.title.toLowerCase().includes(filter.toLowerCase()) || 
                 (t.category && t.category.toLowerCase().includes(filter.toLowerCase())))
            );

            return (
                <div className="space-y-6 animate-accordion-up">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex gap-2 bg-secondary/50 p-1 rounded-lg">
                            <button onClick={() => setTab('receita')} className={cn("px-4 py-2 rounded-md text-sm font-bold transition-all", tab === 'receita' ? 'bg-background shadow-sm text-emerald-500' : 'text-muted-foreground hover:text-foreground')}>
                                Receitas
                            </button>
                            <button onClick={() => setTab('despesa')} className={cn("px-4 py-2 rounded-md text-sm font-bold transition-all", tab === 'despesa' ? 'bg-background shadow-sm text-rose-500' : 'text-muted-foreground hover:text-foreground')}>
                                Despesas
                            </button>
                        </div>
                        <div className="relative w-full md:w-64">
                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" size={14} />
                            <Input 
                                placeholder="Buscar transação..." 
                                className="pl-9 bg-secondary/30 border-transparent focus:bg-background transition-all"
                                value={filter}
                                onChange={e => setFilter(e.target.value)}
                            />
                        </div>
                    </div>

                    <Card className="overflow-hidden border-white/5 bg-card/50 backdrop-blur-sm">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-secondary/50 text-muted-foreground font-display uppercase text-xs tracking-wider">
                                    <tr>
                                        <th className="px-6 py-4">Data</th>
                                        <th className="px-6 py-4">Descrição</th>
                                        <th className="px-6 py-4">Banco</th>
                                        {tab === 'despesa' && <th className="px-6 py-4">Categoria</th>}
                                        <th className="px-6 py-4 text-right">Valor</th>
                                        <th className="px-6 py-4 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-border/50">
                                    {filtered.map(t => (
                                        <tr key={t.id} className="hover:bg-white/5 transition-colors group">
                                            <td className="px-6 py-4 font-mono text-muted-foreground text-xs">{t.date}</td>
                                            <td className="px-6 py-4 font-bold text-foreground">{t.title}</td>
                                            <td className="px-6 py-4 text-muted-foreground">{t.bank || '-'}</td>
                                            {tab === 'despesa' && (
                                                <td className="px-6 py-4">
                                                    <Badge variant="secondary">{t.category}</Badge>
                                                </td>
                                            )}
                                            <td className={cn("px-6 py-4 text-right font-mono font-bold", tab === 'receita' ? 'text-emerald-500' : 'text-rose-500')}>
                                                {tab === 'receita' ? '+' : '-'} {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.value)}
                                            </td>
                                            <td className="px-6 py-4 text-center">
                                                <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-destructive" onClick={() => onDelete(t.id)}>
                                                    <Icon name="trash" size={14} />
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                    {filtered.length === 0 && (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-12 text-center text-muted-foreground">
                                                Nenhum registro encontrado.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        const TransactionModal = ({ isOpen, onClose, type, onSave }) => {
            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                // Simple validation
                onSave({
                    ...data,
                    value: parseFloat(data.value),
                    type
                });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <motion.div 
                        initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                        className="absolute inset-0 bg-black/60 backdrop-blur-sm" 
                        onClick={onClose}
                    />
                    <motion.div 
                        initial={{ scale: 0.95, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} exit={{ scale: 0.95, opacity: 0 }}
                        className="relative z-10 w-full max-w-lg"
                    >
                        <Card className="border-white/10 bg-slate-900 shadow-2xl">
                            <div className="p-6 border-b border-white/10 flex justify-between items-center">
                                <h3 className={cn("font-display text-xl font-bold", type === 'receita' ? 'text-emerald-500' : 'text-rose-500')}>
                                    {type === 'receita' ? 'Nova Receita' : 'Nova Despesa'}
                                </h3>
                                <button onClick={onClose} className="text-muted-foreground hover:text-foreground"><Icon name="x" /></button>
                            </div>
                            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold uppercase text-muted-foreground">Descrição</label>
                                    <Input name="title" required placeholder="Ex: Salário, Mercado..." autoFocus />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold uppercase text-muted-foreground">Valor (R$)</label>
                                        <Input name="value" type="number" step="0.01" required placeholder="0,00" />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold uppercase text-muted-foreground">Data</label>
                                        <Input name="date" type="date" required defaultValue={new Date().toISOString().split('T')[0]} />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold uppercase text-muted-foreground">Banco</label>
                                        <Input name="bank" list="banks" placeholder="Selecione..." />
                                        <datalist id="banks">
                                            <option value="Nubank" /><option value="Inter" /><option value="Itaú" /><option value="Bradesco" />
                                        </datalist>
                                    </div>
                                    {type === 'despesa' && (
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold uppercase text-muted-foreground">Categoria</label>
                                            <select name="category" className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:ring-2 focus:ring-ring">
                                                <option>Moradia</option><option>Alimentação</option><option>Lazer</option><option>Transporte</option><option>Outros</option>
                                            </select>
                                        </div>
                                    )}
                                </div>
                                <Button type="submit" className={cn("w-full mt-4 font-bold text-base h-12", type === 'receita' ? 'bg-emerald-600 hover:bg-emerald-700 text-white' : 'bg-rose-600 hover:bg-rose-700 text-white')}>
                                    Salvar Registro
                                </Button>
                            </form>
                        </Card>
                    </motion.div>
                </div>
            );
        }

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard'); // dashboard | datagrid
            const [transactions, setTransactions] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: 'receita' });

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const q = query(collection(db, "transacoes_financeiras"), where("uid", "==", u.uid), orderBy("date", "desc"));
                        onSnapshot(q, (snap) => {
                            setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        });
                    } else {
                        setTransactions([]);
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleSave = async (data) => {
                await addDoc(collection(db, "transacoes_financeiras"), {
                    ...data,
                    uid: user.uid,
                    createdAt: Timestamp.now()
                });
                setModalConfig({ ...modalConfig, isOpen: false });
            };

            const handleDelete = async (id) => {
                if (confirm("Deseja excluir este registro?")) {
                    await deleteDoc(doc(db, "transacoes_financeiras", id));
                }
            };

            // Excel Import
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'array' });
                    const batch = writeBatch(db);
                    let count = 0;
                    wb.SheetNames.forEach(sheet => {
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);
                        rows.forEach(row => {
                            // Basic mapping logic (simplified for React version)
                            const keys = Object.keys(row).reduce((acc, k) => { acc[k.toLowerCase().trim()] = row[k]; return acc; }, {});
                            let type = 'despesa';
                            if (keys['origem'] || sheet.toLowerCase().includes('receita')) type = 'receita';
                            
                            // Value parsing
                            let val = keys['valor'] || keys['quantia'] || 0;
                            if (typeof val === 'string') val = parseFloat(val.replace(/[R$\s.]/g, '').replace(',', '.'));
                            
                            if (val > 0) {
                                batch.set(doc(collection(db, "transacoes_financeiras")), {
                                    uid: user.uid,
                                    type,
                                    value: val,
                                    title: keys['descrição'] || keys['origem'] || 'Importado',
                                    date: new Date().toISOString().split('T')[0], // Default date if missing
                                    category: keys['categoria'] || 'Geral',
                                    bank: keys['banco'] || 'Outros',
                                    createdAt: Timestamp.now()
                                });
                                count++;
                            }
                        });
                    });
                    if (count > 0) await batch.commit();
                    alert(`${count} registros importados!`);
                };
                reader.readAsArrayBuffer(file);
            };

            if (!user) return <LoginScreen />;

            return (
                <div className="flex h-screen bg-background overflow-hidden font-sans text-foreground selection:bg-primary selection:text-primary-foreground">
                    {/* Sidebar */}
                    <aside className="w-20 lg:w-64 border-r bg-card/30 flex flex-col justify-between z-20">
                        <div>
                            <div className="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-border/50">
                                <div className="w-10 h-10 bg-primary/20 rounded-xl flex items-center justify-center text-primary mr-3">
                                    <Icon name="wallet" size={20} />
                                </div>
                                <span className="hidden lg:block font-display font-bold text-xl tracking-tight">Finanças<span className="text-primary">.</span></span>
                            </div>
                            <nav className="p-4 space-y-2">
                                <Button variant={view === 'dashboard' ? 'secondary' : 'ghost'} className="w-full justify-start gap-3" onClick={() => setView('dashboard')}>
                                    <Icon name="layout-grid" size={18} /> <span className="hidden lg:block">Visão Geral</span>
                                </Button>
                                <Button variant={view === 'datagrid' ? 'secondary' : 'ghost'} className="w-full justify-start gap-3" onClick={() => setView('datagrid')}>
                                    <Icon name="table" size={18} /> <span className="hidden lg:block">Lançamentos</span>
                                </Button>
                            </nav>
                        </div>
                        <div className="p-4 border-t border-border/50">
                            <div className="flex items-center gap-3 mb-4 px-2">
                                <img src={user.photoURL} className="w-8 h-8 rounded-full border border-border" />
                                <div className="hidden lg:block overflow-hidden">
                                    <p className="text-sm font-bold truncate">{user.displayName}</p>
                                    <p className="text-xs text-muted-foreground">Plano Pro</p>
                                </div>
                            </div>
                            <Button variant="outline" size="sm" className="w-full justify-start gap-2" onClick={() => signOut(auth)}>
                                <Icon name="log-out" size={14} /> <span className="hidden lg:block">Sair</span>
                            </Button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col relative overflow-hidden">
                        {/* Background Gradients for Main Area */}
                        <div className="absolute inset-0 pointer-events-none">
                            <div className="absolute top-[-10%] right-[-5%] w-[30%] h-[30%] bg-primary/10 rounded-full blur-[100px]"></div>
                        </div>

                        {/* Header */}
                        <header className="h-20 border-b border-border/50 bg-background/50 backdrop-blur-md flex items-center justify-between px-8 z-10">
                            <div>
                                <h2 className="font-display text-2xl font-bold">{view === 'dashboard' ? 'Dashboard' : 'Base de Dados'}</h2>
                                <p className="text-xs text-muted-foreground">{new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                            </div>
                            <div className="flex gap-3">
                                <label className="cursor-pointer">
                                    <input type="file" className="hidden" accept=".xlsx,.csv" onChange={handleFileUpload} />
                                    <Button variant="outline" size="sm" className="gap-2">
                                        <Icon name="upload" size={14} /> Importar
                                    </Button>
                                </label>
                                <Button size="sm" className="bg-emerald-600 hover:bg-emerald-700 text-white gap-2" onClick={() => setModalConfig({ isOpen: true, type: 'receita' })}>
                                    <Icon name="plus" size={14} /> Receita
                                </Button>
                                <Button size="sm" variant="destructive" className="gap-2" onClick={() => setModalConfig({ isOpen: true, type: 'despesa' })}>
                                    <Icon name="minus" size={14} /> Despesa
                                </Button>
                            </div>
                        </header>

                        {/* Content Scroll Area */}
                        <div className="flex-1 overflow-y-auto p-8 relative z-10">
                            <AnimatePresence mode="wait">
                                {view === 'dashboard' ? (
                                    <motion.div key="dash" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
                                        <Dashboard transactions={transactions} />
                                    </motion.div>
                                ) : (
                                    <motion.div key="grid" initial={{ opacity: 0, x: 10 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -10 }}>
                                        <Datagrid transactions={transactions} onDelete={handleDelete} />
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </main>

                    <TransactionModal 
                        isOpen={modalConfig.isOpen} 
                        type={modalConfig.type} 
                        onClose={() => setModalConfig({ ...modalConfig, isOpen: false })} 
                        onSave={handleSave} 
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

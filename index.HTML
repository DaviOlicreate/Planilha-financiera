<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Pro | Dashboard</title>
    
    <!-- Google Fonts (Modernas e Limpas) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            surface: '#1e293b',
                            accent: '#3b82f6', // Azul moderno
                            receita: '#10b981', // Verde Esmeralda
                            despesa: '#ef4444', // Vermelho Vibrante
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* CSS Personalizado para Efeitos Avançados */
        body { background-color: #0f172a; overflow-x: hidden; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Grid da Tabela */
        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.05); color: white; }
        
        /* Dashboard Fullscreen Mode */
        .dashboard-fullscreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 50;
            background: #0f172a;
            overflow-y: auto;
            display: none; /* Controlado via JS */
        }
        .dashboard-fullscreen.active { display: block; animation: fadeIn 0.3s ease-out; }

        /* Card Hover Effects */
        .menu-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="text-slate-300 font-sans antialiased selection:bg-brand-accent selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0f172a] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 to-[#0f172a]">
        <div class="glass p-10 rounded-3xl max-w-md w-full text-center relative overflow-hidden border border-slate-700/50 shadow-2xl animate-fade-in">
            <!-- Background Glows -->
            <div class="absolute -top-20 -left-20 w-60 h-60 bg-brand-accent/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-20 -right-20 w-60 h-60 bg-brand-receita/20 rounded-full blur-[80px]"></div>

            <div class="relative z-10">
                <div class="w-24 h-24 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl flex items-center justify-center shadow-lg border border-slate-700 mx-auto mb-8">
                    <i class="fa-solid fa-chart-pie text-brand-accent text-5xl"></i>
                </div>
                <h1 class="font-display text-4xl font-bold text-white mb-2">Financeiro <span class="text-brand-accent">Pro</span></h1>
                <p class="text-slate-400 mb-10">Gestão inteligente para suas finanças.</p>
                
                <button id="btn-login-google" class="w-full bg-white hover:bg-slate-100 text-slate-900 font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl hover:scale-[1.01] group">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                    <span>Entrar com Google</span>
                </button>
                <p id="login-error" class="text-brand-despesa text-xs mt-4 hidden"></p>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-content" class="hidden flex h-screen overflow-hidden">
        
        <!-- SIDEBAR (Navegação Fixa) -->
        <aside class="w-20 lg:w-64 bg-slate-900 border-r border-slate-800 flex flex-col justify-between z-40 transition-all duration-300">
            <div>
                <!-- Logo -->
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                    <i class="fa-solid fa-wallet text-brand-accent text-2xl lg:mr-3"></i>
                    <span class="hidden lg:block font-display font-bold text-xl text-white">Finanças</span>
                </div>

                <!-- Nav Items -->
                <nav class="mt-8 space-y-2 px-2">
                    <button onclick="switchView('home')" id="nav-home" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-brand-accent bg-slate-800/50 font-medium transition-all group">
                        <i class="fa-solid fa-house text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Início</span>
                    </button>
                    
                    <button onclick="switchView('datagrid')" id="nav-datagrid" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-table-columns text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Base de Dados</span>
                    </button>

                    <button onclick="openDashboardFull()" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-brand-accent hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Dashboard</span>
                    </button>
                </nav>
            </div>

            <!-- User Footer -->
            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 justify-center lg:justify-start cursor-pointer hover:bg-slate-800 p-2 rounded-lg transition-colors" onclick="signOut(auth)">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-slate-700">
                    <div class="hidden lg:block overflow-hidden">
                        <p id="user-name" class="text-xs font-bold text-white truncate">Usuário</p>
                        <p class="text-[10px] text-slate-500">Sair</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto bg-[#0f172a] relative">
            
            <!-- VIEW: HOME (MENU PRINCIPAL) -->
            <div id="view-home" class="p-8 lg:p-12 max-w-7xl mx-auto animate-slide-up">
                <header class="mb-10 flex justify-between items-end">
                    <div>
                        <p class="text-brand-accent font-bold uppercase tracking-wider text-xs mb-1">Bem-vindo de volta</p>
                        <h2 class="font-display text-4xl font-bold text-white">Visão Geral</h2>
                    </div>
                    <div class="text-right hidden sm:block">
                        <p id="current-date" class="text-slate-400 text-sm">...</p>
                    </div>
                </header>

                <!-- Cards Menu Principal -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dashboard Card -->
                    <div onclick="openDashboardFull()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden col-span-1 md:col-span-2 lg:col-span-2">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-accent/10 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-brand-accent/20 transition-all"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div>
                                <div class="w-12 h-12 rounded-xl bg-brand-accent/20 text-brand-accent flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Dashboard Interativo</h3>
                                <p class="text-slate-400 max-w-md">Visualize gráficos, analise tendências e acompanhe suas metas em tela cheia.</p>
                            </div>
                            <div class="mt-6 flex items-center text-brand-accent font-bold text-sm">
                                <span>ABRIR AGORA</span>
                                <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Botão Registrar Despesa -->
                    <div onclick="openModal('despesa')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-despesa hover:border-brand-despesa">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-despesa/20 text-brand-despesa flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Despesa</h3>
                            <p class="text-slate-400 text-sm">Adicionar saída manual.</p>
                        </div>
                    </div>

                     <!-- Botão Registrar Receita -->
                     <div onclick="openModal('receita')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-receita hover:border-brand-receita">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-receita/20 text-brand-receita flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Receita</h3>
                            <p class="text-slate-400 text-sm">Adicionar entrada manual.</p>
                        </div>
                    </div>

                    <!-- Base de Dados -->
                    <div onclick="switchView('datagrid')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden md:col-span-2">
                        <div class="relative z-10 flex items-center gap-6">
                            <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center text-2xl text-slate-300 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-database"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Base de Dados Completa</h3>
                                <p class="text-slate-400 text-sm mt-1">Gerencie, edite e filtre todas as suas transações em uma tabela dinâmica.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Importar Excel -->
                    <label class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center border border-dashed border-slate-600 hover:border-brand-accent hover:bg-slate-800/50">
                        <input type="file" id="file-upload" accept=".xlsx, .xls, .csv" class="hidden">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <h3 class="text-white font-bold">Importar Excel</h3>
                        <p id="import-status" class="text-xs text-slate-400 mt-1">Clique para carregar planilha</p>
                    </label>

                </div>
            </div>

            <!-- VIEW: DATAGRID (TABELAS) -->
            <div id="view-datagrid" class="hidden h-full flex flex-col animate-fade-in">
                <!-- Header Grid -->
                <div class="px-8 py-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur flex justify-between items-center">
                    <div>
                        <h2 class="font-display text-2xl font-bold text-white">Base de Dados</h2>
                        <p class="text-slate-400 text-sm">Gerenciamento de registros</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input type="text" id="grid-search" placeholder="Buscar categoria, banco..." class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-1 focus:ring-brand-accent focus:border-brand-accent outline-none w-64 transition-all">
                        </div>
                        <button onclick="clearAllData()" class="px-4 py-2 bg-slate-800 hover:bg-brand-despesa/20 hover:text-brand-despesa text-slate-400 rounded-lg text-sm font-bold transition-all border border-slate-700">
                            <i class="fa-solid fa-trash-can mr-2"></i> Limpar
                        </button>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="flex-1 overflow-auto p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Table: Receitas -->
                    <div class="glass rounded-2xl overflow-hidden flex flex-col border-t-4 border-t-brand-receita">
                        <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-brand-receita flex items-center gap-2"><i class="fa-solid fa-arrow-up"></i> Receitas</h3>
                            <span id="count-rec" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">0 itens</span>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider">
                                    <tr>
                                        <th class="px-4 py-3">Data</th>
                                        <th class="px-4 py-3">Origem</th>
                                        <th class="px-4 py-3">Banco</th>
                                        <th class="px-4 py-3 text-right">Valor</th>
                                        <th class="px-4 py-3 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-receitas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Table: Despesas -->
                    <div class="glass rounded-2xl overflow-hidden flex flex-col border-t-4 border-t-brand-despesa">
                        <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-brand-despesa flex items-center gap-2"><i class="fa-solid fa-arrow-down"></i> Despesas</h3>
                            <span id="count-desp" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">0 itens</span>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider">
                                    <tr>
                                        <th class="px-4 py-3">Data</th>
                                        <th class="px-4 py-3">Descrição</th>
                                        <th class="px-4 py-3">Categoria</th>
                                        <th class="px-4 py-3">Definição</th>
                                        <th class="px-4 py-3 text-right">Valor</th>
                                        <th class="px-4 py-3 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-despesas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <!-- DASHBOARD FULLSCREEN OVERLAY -->
    <div id="dashboard-full" class="dashboard-fullscreen bg-[#0f172a] text-slate-200">
        
        <!-- Dashboard Nav (Floating Island) -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="glass-strong px-2 py-2 rounded-full flex gap-1 shadow-2xl border border-slate-700/50">
                <button onclick="closeDashboardFull()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition-colors" title="Voltar ao Menu">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="w-px h-6 bg-slate-700 my-auto mx-2"></div>
                <button class="px-4 py-2 rounded-full bg-brand-accent text-white text-sm font-bold shadow-lg shadow-brand-accent/20">Visão Geral</button>
                <button class="px-4 py-2 rounded-full hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium transition-colors">Categorias</button>
                <button class="px-4 py-2 rounded-full hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium transition-colors">Evolução</button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="p-8 lg:p-16 max-w-[1600px] mx-auto mt-12 space-y-8 animate-slide-up">
            
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Saldo -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-accent/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Saldo Atual</p>
                    <h3 id="dash-saldo" class="text-4xl font-display font-bold text-white">R$ 0,00</h3>
                    <div class="mt-4 h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-brand-accent w-full"></div>
                    </div>
                </div>
                <!-- Receitas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-receita/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Entradas</p>
                    <h3 id="dash-rec" class="text-4xl font-display font-bold text-brand-receita">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-receita">
                        <i class="fa-solid fa-arrow-trend-up"></i> <span>Acumulado</span>
                    </div>
                </div>
                <!-- Despesas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-despesa/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Saídas</p>
                    <h3 id="dash-desp" class="text-4xl font-display font-bold text-brand-despesa">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-despesa">
                        <i class="fa-solid fa-arrow-trend-down"></i> <span>Acumulado</span>
                    </div>
                </div>
                <!-- Economia -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden flex flex-col justify-center items-center">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="#1e293b" stroke-width="8" fill="transparent"></circle>
                            <circle id="circle-progress" cx="48" cy="48" r="40" stroke="#3b82f6" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="transition-all duration-1000"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="dash-eco-perc" class="text-lg font-bold text-white">0%</span>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-slate-400 uppercase font-bold">Taxa de Poupança</p>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Bar Chart Main -->
                <div class="glass p-6 rounded-3xl lg:col-span-2">
                    <h4 class="font-bold text-white mb-6">Fluxo Financeiro Anual</h4>
                    <div class="h-[300px]">
                        <canvas id="chart-main"></canvas>
                    </div>
                </div>
                <!-- Doughnut Categories -->
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-6">Top Despesas (Categoria)</h4>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="chart-cat"></canvas>
                    </div>
                </div>
            </div>

             <!-- Charts Row 2 -->
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-6">Gastos por Banco</h4>
                    <div class="h-[250px]">
                        <canvas id="chart-bank"></canvas>
                    </div>
                </div>
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-6">Tipos de Despesa (50/30/20)</h4>
                    <div class="h-[250px]">
                        <canvas id="chart-type"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL (Unified) -->
    <div id="modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 id="modal-title" class="font-display text-xl font-bold text-white">Nova Transação</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="form-transaction" class="p-6 space-y-4">
                <input type="hidden" id="form-type">
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descrição / Título</label>
                    <input type="text" id="form-desc" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" placeholder="Ex: Salário, Mercado...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor (R$)</label>
                        <input type="number" step="0.01" id="form-val" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data</label>
                        <input type="date" id="form-date" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Banco</label>
                        <input type="text" id="form-bank" list="bank-list" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent outline-none">
                        <datalist id="bank-list">
                            <option value="Nubank"><option value="Inter"><option value="Itaú"><option value="Bradesco"><option value="Caixa"><option value="Santander">
                        </datalist>
                    </div>
                    <!-- Campos Dinâmicos (Categoria/Definição) -->
                    <div id="field-cat-container">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Categoria</label>
                        <select id="form-cat" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent outline-none">
                            <option value="Moradia">Moradia</option><option value="Alimentação">Alimentação</option><option value="Transporte">Transporte</option><option value="Lazer">Lazer</option><option value="Saúde">Saúde</option><option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>

                <!-- Campo Extra Despesa -->
                <div id="field-def-container" class="hidden">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Definição (Regra 50/30/20)</label>
                    <select id="form-def" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent outline-none">
                        <option value="Necessidades (50%)">Necessidades (50%)</option>
                        <option value="Desejos (30%)">Desejos (30%)</option>
                        <option value="Poupança/Dívidas (20%)">Poupança/Dívidas (20%)</option>
                    </select>
                </div>

                <button type="submit" id="btn-save" class="w-full bg-brand-accent hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all mt-4">
                    Salvar Registro
                </button>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, where, Timestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWA5-o7lvPv7zybt1B-k7HdKcgPNYQOEc",
            authDomain: "planilha-financeira-fca35.firebaseapp.com",
            projectId: "planilha-financeira-fca35",
            storageBucket: "planilha-financeira-fca35.firebasestorage.app",
            messagingSenderId: "768116977602",
            appId: "1:768116977602:web:c824c055bf6f578eee305b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let transactions = [];
        let chartInstances = {};

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.displayName.split(' ')[0];
                document.getElementById('user-avatar').src = user.photoURL;
                loadData();
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.signOut = () => signOut(auth);
        document.getElementById('btn-login-google').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));

        // --- DATA LOAD ---
        function loadData() {
            const q = query(collection(db, "transacoes_financeiras"), orderBy("date", "desc"));
            onSnapshot(q, (snap) => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.uid === currentUser.uid);
                updateInterface();
            });
        }

        // --- UI LOGIC ---
        function updateInterface() {
            // Filter Arrays
            const receitas = transactions.filter(t => t.type === 'receita');
            const despesas = transactions.filter(t => t.type === 'despesa');

            // 1. DataGrid Render
            renderTable('tbody-receitas', receitas, ['date', 'title', 'bank', 'value'], 'receita');
            renderTable('tbody-despesas', despesas, ['date', 'title', 'category', 'definition', 'value'], 'despesa');
            
            document.getElementById('count-rec').textContent = `${receitas.length} registros`;
            document.getElementById('count-desp').textContent = `${despesas.length} registros`;

            // 2. KPIs Dashboard
            const totalRec = receitas.reduce((sum, t) => sum + t.value, 0);
            const totalDesp = despesas.reduce((sum, t) => sum + t.value, 0);
            const saldo = totalRec - totalDesp;
            
            const fmt = new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('dash-saldo').textContent = fmt.format(saldo);
            document.getElementById('dash-rec').textContent = fmt.format(totalRec);
            document.getElementById('dash-desp').textContent = fmt.format(totalDesp);

            // Savings Circle
            const savingsRate = totalRec > 0 ? ((totalRec - totalDesp) / totalRec) : 0;
            const percentage = Math.max(0, Math.min(100, Math.round(savingsRate * 100)));
            document.getElementById('dash-eco-perc').textContent = `${percentage}%`;
            
            const circle = document.getElementById('circle-progress');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Color logic for circle
            circle.style.stroke = percentage > 20 ? '#10b981' : (percentage > 0 ? '#fbbf24' : '#ef4444');

            // 3. Update Charts
            updateCharts(receitas, despesas);
        }

        function renderTable(elementId, data, cols, type) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            
            // Apply Search Filter
            const term = document.getElementById('grid-search').value.toLowerCase();
            const filtered = data.filter(t => 
                (t.title && t.title.toLowerCase().includes(term)) || 
                (t.category && t.category.toLowerCase().includes(term)) ||
                (t.bank && t.bank.toLowerCase().includes(term))
            );

            filtered.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "table-row-hover border-b border-slate-800 transition-colors";
                
                let html = '';
                cols.forEach(col => {
                    if(col === 'date') html += `<td class="px-4 py-4 whitespace-nowrap font-mono text-xs text-slate-500">${formatDate(t.date)}</td>`;
                    else if(col === 'value') {
                        const color = type === 'receita' ? 'text-brand-receita' : 'text-brand-despesa';
                        const sign = type === 'receita' ? '+' : '-';
                        html += `<td class="px-4 py-4 text-right font-bold ${color}">${sign} ${t.value.toFixed(2)}</td>`;
                    }
                    else if(col === 'category' || col === 'definition') {
                        html += `<td class="px-4 py-4"><span class="bg-slate-800 border border-slate-700 text-xs px-2 py-1 rounded text-slate-300">${t[col] || '-'}</span></td>`;
                    }
                    else html += `<td class="px-4 py-4 font-medium text-slate-300">${t[col] || '-'}</td>`;
                });

                // Actions
                html += `<td class="px-4 py-4 text-center">
                    <button onclick="deleteItem('${t.id}')" class="text-slate-600 hover:text-brand-despesa transition-colors"><i class="fa-solid fa-trash"></i></button>
                </td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        window.deleteItem = async (id) => {
            if(confirm('Tem certeza?')) await deleteDoc(doc(db, "transacoes_financeiras", id));
        }

        document.getElementById('grid-search').addEventListener('input', updateInterface);
        window.clearAllData = async () => {
            if(!confirm("CUIDADO: Isso apagará tudo!")) return;
            const batch = writeBatch(db);
            transactions.forEach(t => batch.delete(doc(db, "transacoes_financeiras", t.id)));
            await batch.commit();
        }

        // --- CHARTJS LOGIC ---
        function updateCharts(rec, desp) {
            const ctxMain = document.getElementById('chart-main');
            const ctxCat = document.getElementById('chart-cat');
            const ctxBank = document.getElementById('chart-bank');
            const ctxType = document.getElementById('chart-type');

            if(!ctxMain || document.getElementById('dashboard-full').style.display === 'none') return;

            // Prepare Data Groups
            const months = {};
            [...rec, ...desp].forEach(t => {
                const k = t.date.substring(0, 7); // YYYY-MM
                if(!months[k]) months[k] = {rec:0, desp:0};
                if(t.type === 'receita') months[k].rec += t.value;
                else months[k].desp += t.value;
            });
            const labelsM = Object.keys(months).sort();

            // 1. Main Chart (Bar)
            if(chartInstances.main) chartInstances.main.destroy();
            chartInstances.main = new Chart(ctxMain, {
                type: 'bar',
                data: {
                    labels: labelsM,
                    datasets: [
                        { label: 'Entradas', data: labelsM.map(m => months[m].rec), backgroundColor: '#10b981', borderRadius: 6 },
                        { label: 'Saídas', data: labelsM.map(m => months[m].desp), backgroundColor: '#ef4444', borderRadius: 6 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });

            // 2. Categories (Doughnut)
            const cats = {};
            desp.forEach(t => {
                const c = t.category || 'Outros';
                cats[c] = (cats[c] || 0) + t.value;
            });
            if(chartInstances.cat) chartInstances.cat.destroy();
            chartInstances.cat = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#cbd5e1' } } } }
            });

            // 3. Bank (Bar Horizontal)
            const banks = {};
            desp.forEach(t => {
                const b = t.bank || 'Outros';
                banks[b] = (banks[b] || 0) + t.value;
            });
            if(chartInstances.bank) chartInstances.bank.destroy();
            chartInstances.bank = new Chart(ctxBank, {
                type: 'bar',
                data: {
                    labels: Object.keys(banks),
                    datasets: [{ label: 'Gasto por Banco', data: Object.values(banks), backgroundColor: '#3b82f6', borderRadius: 4 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#334155' } } } }
            });

             // 4. Type 50/30/20 (Pie)
             const types = {};
            desp.forEach(t => {
                const d = t.definition || 'Outros';
                types[d] = (types[d] || 0) + t.value;
            });
            if(chartInstances.type) chartInstances.type.destroy();
            chartInstances.type = new Chart(ctxType, {
                type: 'pie',
                data: {
                    labels: Object.keys(types),
                    datasets: [{ data: Object.values(types), backgroundColor: ['#ef4444', '#eab308', '#3b82f6', '#94a3b8'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#cbd5e1' } } } }
            });
        }

        // --- NAVIGATION & MODALS ---
        window.switchView = (viewName) => {
            ['home', 'datagrid'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Nav Active State
            document.getElementById('nav-home').classList.remove('text-brand-accent', 'bg-slate-800/50');
            document.getElementById('nav-datagrid').classList.remove('text-brand-accent', 'bg-slate-800/50');
            
            document.getElementById(`nav-${viewName}`).classList.add('text-brand-accent', 'bg-slate-800/50');
            document.getElementById(`nav-${viewName}`).classList.remove('text-slate-400');
        }

        window.openDashboardFull = () => {
            document.getElementById('dashboard-full').classList.add('active');
            updateInterface(); // Force chart render
        }
        window.closeDashboardFull = () => document.getElementById('dashboard-full').classList.remove('active');

        window.openModal = (type) => {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('form-type').value = type;
            document.getElementById('modal-title').textContent = type === 'receita' ? 'Nova Receita' : 'Nova Despesa';
            document.getElementById('modal-title').className = `font-display text-xl font-bold ${type === 'receita' ? 'text-brand-receita' : 'text-brand-despesa'}`;
            document.getElementById('btn-save').className = `w-full font-bold py-4 rounded-xl shadow-lg transition-all mt-4 text-white ${type === 'receita' ? 'bg-brand-receita hover:bg-emerald-600 shadow-emerald-500/20' : 'bg-brand-despesa hover:bg-rose-600 shadow-rose-500/20'}`;
            
            // Toggle Fields
            if(type === 'receita') {
                document.getElementById('field-cat-container').classList.add('hidden');
                document.getElementById('field-def-container').classList.add('hidden');
            } else {
                document.getElementById('field-cat-container').classList.remove('hidden');
                document.getElementById('field-def-container').classList.remove('hidden');
            }
            document.getElementById('form-date').valueAsDate = new Date();
        }
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        // --- FORM SUBMIT ---
        document.getElementById('form-transaction').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('form-type').value;
            const data = {
                uid: currentUser.uid,
                type: type,
                title: document.getElementById('form-desc').value,
                value: parseFloat(document.getElementById('form-val').value),
                date: document.getElementById('form-date').value,
                bank: document.getElementById('form-bank').value,
                createdAt: Timestamp.now()
            };

            if(type === 'despesa') {
                data.category = document.getElementById('form-cat').value;
                data.definition = document.getElementById('form-def').value;
            } else {
                // Mapeando "Origem" (usando Title) para Receita
                data.origin = data.title; 
            }

            await addDoc(collection(db, "transacoes_financeiras"), data);
            closeModal();
            document.getElementById('form-transaction').reset();
        });

        // --- IMPORT EXCEL LOGIC (Refatorada) ---
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const status = document.getElementById('import-status');
            status.textContent = "Processando...";
            status.className = "text-xs text-brand-accent mt-1 animate-pulse";

            const reader = new FileReader();
            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, {type: 'array'});
                const batch = writeBatch(db);
                let count = 0;

                workbook.SheetNames.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    
                    rows.forEach(row => {
                        // Normaliza chaves (remove espaços, lowercase e acentos)
                        const keys = Object.keys(row).reduce((acc, k) => { 
                            const cleanKey = k.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                            acc[cleanKey] = row[k]; 
                            return acc; 
                        }, {});

                        // Detecção Inteligente
                        let type = 'despesa';
                        if(keys['origem'] || sheetName.toLowerCase().includes('receita')) type = 'receita';

                        // Mapeamento
                        const val = parseValue(keys['valor'] || keys['quantia'] || keys['total'] || keys['saida'] || keys['entrada']);
                        const date = parseDate(keys['data'] || keys['dia']);
                        
                        if(val > 0 && date) {
                            const docData = {
                                uid: currentUser.uid,
                                type: type,
                                value: val,
                                date: date,
                                bank: keys['banco'] || keys['instituicao bancaria'] || keys['conta'] || 'Não informado',
                                title: keys['descricao'] || keys['origem'] || 'Sem título',
                                createdAt: Timestamp.now()
                            };

                            if(type === 'despesa') {
                                docData.category = keys['categoria'] || keys['despesa'] || 'Outros';
                                docData.definition = keys['definicao'] || keys['tipo'] || 'Outros';
                                docData.description = keys['descricao'] || '';
                                docData.externalId = keys['id'] || ''; // Mod 1: Save ID
                            } else {
                                docData.origin = keys['origem'] || keys['descricao'];
                            }

                            batch.set(doc(collection(db, "transacoes_financeiras")), docData);
                            count++;
                        }
                    });
                });

                if(count > 0) await batch.commit();
                status.textContent = `${count} itens importados!`;
                status.className = "text-xs text-brand-receita mt-1";
                setTimeout(() => status.textContent = "Clique para carregar planilha", 3000);
            };
            reader.readAsArrayBuffer(file);
        });

        // Utils
        function parseValue(v) {
            if (typeof v === 'number') return v;
            if (!v) return 0;
            
            // Convert to string and clean
            let str = v.toString().trim();
            
            // Handle Excel Accounting Parentheses for negative: "(1.000,00)" -> "-1.000,00"
            if (str.startsWith('(') && str.endsWith(')')) {
                str = '-' + str.slice(1, -1);
            }
            
            // Remove R$, spaces, and dots (thousands separator in BR)
            // Replace comma with dot
            str = str.replace(/[R$\s\.]/g, '').replace(',', '.');
            
            const parsed = parseFloat(str);
            return isNaN(parsed) ? 0 : parsed;
        }

        function parseDate(d) {
            if(!d) return new Date().toISOString().split('T')[0];
            if(typeof d === 'number') { // Excel serial date
                const date = new Date(Math.round((d - 25569)*86400*1000));
                return date.toISOString().split('T')[0];
            }
            if(d.includes('/')) {
                const p = d.split('/');
                if(p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`;
            }
            return d;
        }
        function formatDate(d) {
            const p = d.split('-');
            return `${p[2]}/${p[1]}/${p[0]}`;
        }
        
        // Date Display
        const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});

    </script>
</body>
</html>

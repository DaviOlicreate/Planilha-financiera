<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Pro | Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            surface: '#1e293b',
                            accent: '#3b82f6', // Azul
                            receita: '#10b981', // Verde
                            despesa: '#ef4444', // Vermelho
                            warning: '#f59e0b', // Amarelo
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #0f172a; overflow-x: hidden; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.05); color: white; }
        
        .dashboard-fullscreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 50;
            background: #0f172a;
            overflow-y: auto;
            display: none;
        }
        .dashboard-fullscreen.active { display: block; animation: fadeIn 0.3s ease-out; }

        .menu-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="text-slate-300 font-sans antialiased selection:bg-brand-accent selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0f172a] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 to-[#0f172a]">
        <div class="glass p-10 rounded-3xl max-w-md w-full text-center relative overflow-hidden border border-slate-700/50 shadow-2xl animate-fade-in">
            <div class="absolute -top-20 -left-20 w-60 h-60 bg-brand-accent/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-20 -right-20 w-60 h-60 bg-brand-receita/20 rounded-full blur-[80px]"></div>

            <div class="relative z-10">
                <div class="w-24 h-24 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl flex items-center justify-center shadow-lg border border-slate-700 mx-auto mb-8">
                    <i class="fa-solid fa-chart-pie text-brand-accent text-5xl"></i>
                </div>
                <h1 class="font-display text-4xl font-bold text-white mb-2">Financeiro <span class="text-brand-accent">Pro</span></h1>
                <p class="text-slate-400 mb-10">Gestão inteligente para suas finanças.</p>
                
                <button id="btn-login-google" class="w-full bg-white hover:bg-slate-100 text-slate-900 font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl hover:scale-[1.01] group">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                    <span>Acessar com Google</span>
                </button>
                <p id="login-status" class="text-slate-400 text-xs mt-4 h-4"></p>
                <p id="login-error" class="text-brand-despesa text-xs mt-2 hidden"></p>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-content" class="hidden flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-20 lg:w-64 bg-slate-900 border-r border-slate-800 flex flex-col justify-between z-40 transition-all duration-300">
            <div>
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                    <i class="fa-solid fa-wallet text-brand-accent text-2xl lg:mr-3"></i>
                    <span class="hidden lg:block font-display font-bold text-xl text-white">Finanças</span>
                </div>

                <nav class="mt-8 space-y-2 px-2">
                    <button onclick="switchView('home')" id="nav-home" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-brand-accent bg-slate-800/50 font-medium transition-all group">
                        <i class="fa-solid fa-house text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Início</span>
                    </button>
                    
                    <button onclick="switchView('datagrid')" id="nav-datagrid" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-table-columns text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Base de Dados</span>
                    </button>

                    <button onclick="openDashboardFull()" class="w-full flex items-center justify-center lg:justify-start gap-4 px-4 py-3 rounded-xl text-slate-400 hover:text-brand-accent hover:bg-slate-800 transition-all group">
                        <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden lg:block">Dashboard</span>
                    </button>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 justify-center lg:justify-start cursor-pointer hover:bg-slate-800 p-2 rounded-lg transition-colors" onclick="signOut(auth)">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-slate-700">
                    <div class="hidden lg:block overflow-hidden">
                        <p id="user-name" class="text-xs font-bold text-white truncate">Usuário</p>
                        <p class="text-[10px] text-slate-500">Sair</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto bg-[#0f172a] relative">
            
            <!-- VIEW: HOME -->
            <div id="view-home" class="p-8 lg:p-12 max-w-7xl mx-auto animate-slide-up">
                <header class="mb-10 flex justify-between items-end">
                    <div>
                        <p class="text-brand-accent font-bold uppercase tracking-wider text-xs mb-1">Bem-vindo de volta</p>
                        <h2 class="font-display text-4xl font-bold text-white">Visão Geral</h2>
                    </div>
                    <div class="text-right hidden sm:block">
                        <p id="current-date" class="text-slate-400 text-sm">...</p>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dashboard Card -->
                    <div onclick="openDashboardFull()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden col-span-1 md:col-span-2 lg:col-span-2">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-accent/10 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-brand-accent/20 transition-all"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div>
                                <div class="w-12 h-12 rounded-xl bg-brand-accent/20 text-brand-accent flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Dashboard Interativo</h3>
                                <p class="text-slate-400 max-w-md">Visualize gráficos, analise tendências e acompanhe suas metas em tela cheia.</p>
                            </div>
                            <div class="mt-6 flex items-center text-brand-accent font-bold text-sm">
                                <span>ABRIR AGORA</span>
                                <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Botões Ação Rápida -->
                    <div onclick="openModal('despesa')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-despesa hover:border-brand-despesa">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-despesa/20 text-brand-despesa flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Despesa</h3>
                            <p class="text-slate-400 text-sm">Adicionar saída manual.</p>
                        </div>
                    </div>

                    <div onclick="openModal('receita')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden border-l-4 border-brand-receita hover:border-brand-receita">
                        <div class="relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-brand-receita/20 text-brand-receita flex items-center justify-center text-xl mb-4 group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Registrar Receita</h3>
                            <p class="text-slate-400 text-sm">Adicionar entrada manual.</p>
                        </div>
                    </div>

                    <!-- Base de Dados Link -->
                    <div onclick="switchView('datagrid')" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden md:col-span-2">
                        <div class="relative z-10 flex items-center gap-6">
                            <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center text-2xl text-slate-300 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-database"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Base de Dados Completa</h3>
                                <p class="text-slate-400 text-sm mt-1">Gerencie, edite e filtre todas as suas transações em uma tabela dinâmica.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações -->
                    <div onclick="openSettings()" class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-white mb-3 group-hover:rotate-90 transition-transform">
                            <i class="fa-solid fa-gear"></i>
                        </div>
                        <h3 class="text-white font-bold">Configurações</h3>
                        <p class="text-xs text-slate-400 mt-1">Editar Bancos e Categorias</p>
                    </div>

                    <!-- Importar Excel -->
                    <label class="menu-card glass p-8 rounded-3xl cursor-pointer group relative overflow-hidden flex flex-col items-center justify-center text-center border border-dashed border-slate-600 hover:border-brand-accent hover:bg-slate-800/50">
                        <input type="file" id="file-upload" accept=".xlsx, .xls, .csv" class="hidden">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <h3 class="text-white font-bold">Importar Excel</h3>
                        <p id="import-status" class="text-xs text-slate-400 mt-1">Clique para carregar planilha</p>
                    </label>

                </div>
            </div>

            <!-- VIEW: DATAGRID -->
            <div id="view-datagrid" class="hidden h-full flex flex-col animate-fade-in">
                <!-- Header Grid -->
                <div class="px-8 py-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="font-display text-2xl font-bold text-white">Base de Dados</h2>
                        <p class="text-slate-400 text-sm">Gerenciamento de registros</p>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="relative">
                            <input type="month" id="filter-month" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg px-4 py-2 focus:ring-1 focus:ring-brand-accent focus:border-brand-accent outline-none transition-all cursor-pointer">
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input type="text" id="grid-search" placeholder="Buscar..." class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-1 focus:ring-brand-accent focus:border-brand-accent outline-none w-48 lg:w-64 transition-all">
                        </div>
                        <button onclick="clearAllData()" class="px-4 py-2 bg-slate-800 hover:bg-brand-despesa/20 hover:text-brand-despesa text-slate-400 rounded-lg text-sm font-bold transition-all border border-slate-700">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-8 pt-6 flex gap-6 border-b border-slate-800">
                    <button onclick="switchTableTab('receitas')" id="tab-btn-receitas" class="pb-3 px-2 border-b-2 border-brand-receita text-brand-receita font-bold text-sm uppercase tracking-wider transition-all flex items-center gap-2">
                        <i class="fa-solid fa-arrow-up"></i> Receitas
                        <span id="tab-badge-rec" class="bg-brand-receita/20 text-brand-receita text-[10px] px-2 py-0.5 rounded-full ml-1">0</span>
                    </button>
                    <button onclick="switchTableTab('despesas')" id="tab-btn-despesas" class="pb-3 px-2 border-b-2 border-transparent text-slate-500 hover:text-white font-bold text-sm uppercase tracking-wider transition-all flex items-center gap-2">
                        <i class="fa-solid fa-arrow-down"></i> Despesas
                        <span id="tab-badge-desp" class="bg-slate-800 text-slate-400 text-[10px] px-2 py-0.5 rounded-full ml-1">0</span>
                    </button>
                </div>

                <!-- Tables -->
                <div class="flex-1 overflow-auto p-8">
                    <div id="tab-content-receitas" class="h-full flex flex-col glass rounded-2xl overflow-hidden border-t-4 border-t-brand-receita animate-fade-in">
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider z-10">
                                    <tr>
                                        <th class="px-6 py-4 bg-slate-900/90">Data</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Origem</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Banco</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-right">Valor</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-receitas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-content-despesas" class="hidden h-full flex flex-col glass rounded-2xl overflow-hidden border-t-4 border-t-brand-despesa animate-fade-in">
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="text-xs uppercase bg-slate-900/80 text-slate-300 sticky top-0 font-bold tracking-wider z-10">
                                    <tr>
                                        <th class="px-6 py-4 bg-slate-900/90">Data</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Descrição</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Categoria</th>
                                        <th class="px-6 py-4 bg-slate-900/90">Banco</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-right">Valor</th>
                                        <th class="px-6 py-4 bg-slate-900/90 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-despesas" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- DASHBOARD FULLSCREEN OVERLAY -->
    <div id="dashboard-full" class="dashboard-fullscreen bg-[#0f172a] text-slate-200">
        
        <!-- Dashboard Nav -->
        <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="glass-strong px-2 py-2 rounded-full flex gap-1 shadow-2xl border border-slate-700/50">
                <button onclick="closeDashboardFull()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition-colors" title="Voltar ao Menu">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="w-px h-6 bg-slate-700 my-auto mx-2"></div>
                <div class="flex items-center gap-2 px-3">
                    <span class="text-xs font-bold text-slate-400 uppercase">Mês:</span>
                    <input type="month" id="dash-filter-month" class="bg-transparent text-white font-bold text-sm outline-none border-none w-32 cursor-pointer">
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="p-8 lg:p-16 max-w-[1600px] mx-auto mt-12 space-y-8 animate-slide-up">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Saldo -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-accent/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Saldo em Conta</p>
                    <h3 id="dash-saldo" class="text-4xl font-display font-bold text-white">R$ 0,00</h3>
                    <div class="mt-4 h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-brand-accent w-full"></div>
                    </div>
                </div>
                <!-- Receitas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-receita/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Entradas (Mês)</p>
                    <h3 id="dash-rec" class="text-4xl font-display font-bold text-brand-receita">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-receita">
                        <i class="fa-solid fa-arrow-trend-up"></i> <span>Receitas computadas</span>
                    </div>
                </div>
                <!-- Despesas -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden border-transparent transition-all" id="card-despesa-kpi">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-brand-despesa/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Saídas (Mês)</p>
                    <h3 id="dash-desp" class="text-4xl font-display font-bold text-brand-despesa">R$ 0,00</h3>
                    <div class="mt-4 flex items-center gap-2 text-xs text-brand-despesa" id="kpi-despesa-status">
                         <!-- JS Populates status -->
                    </div>
                </div>
                <!-- Investimentos / Meta -->
                <div class="glass p-6 rounded-3xl relative overflow-hidden flex flex-col justify-center items-center">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="#1e293b" stroke-width="8" fill="transparent"></circle>
                            <circle id="circle-progress" cx="48" cy="48" r="40" stroke="#3b82f6" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="transition-all duration-1000"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="dash-eco-perc" class="text-lg font-bold text-white">0%</span>
                        </div>
                    </div>
                    <p id="label-inv-goal" class="mt-2 text-xs text-slate-400 uppercase font-bold text-center">Meta de Investimento</p>
                </div>
            </div>

            <!-- Charts Row 1: Flow + Top Categories (Restored) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Bar+Line Main -->
                <div class="glass p-6 rounded-3xl lg:col-span-2">
                    <h4 class="font-bold text-white mb-1">Fluxo Financeiro</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Histórico Anual</p>
                    <div class="h-[300px]">
                        <canvas id="chart-main"></canvas>
                    </div>
                </div>
                <!-- Top Categories (Restored Bar) -->
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-1">Top Categorias</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Maiores Despesas (Mês)</p>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="chart-top-cat"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2: Timeline Details (Full Width) -->
            <div class="glass p-6 rounded-3xl">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h4 class="font-bold text-white mb-1">Detalhamento de Despesas (Linha do Tempo)</h4>
                        <p id="chart-timeline-total" class="text-xs text-slate-400 uppercase tracking-wider">Total do período: R$ 0,00</p>
                    </div>
                </div>
                <div class="h-[300px] w-full">
                    <canvas id="chart-timeline"></canvas>
                </div>
            </div>

            <!-- Charts Row 3: Banks & Revenue -->
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-3xl">
                    <h4 class="font-bold text-white mb-1">Gastos por Banco</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Distribuição Institucional</p>
                    <div class="h-[250px]">
                        <canvas id="chart-bank"></canvas>
                    </div>
                </div>
                <div class="glass p-6 rounded-3xl">
                    <h4 id="title-chart-type" class="font-bold text-white mb-1">Fontes de Receita</h4>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Ranking de Entradas</p>
                    <div class="h-[250px]">
                        <canvas id="chart-type"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 z-[75] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('settings-modal')"></div>
        <div class="relative w-full max-w-2xl glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-display text-xl font-bold text-white">Configurações de Listas</h3>
                <button onclick="closeModal('settings-modal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 flex-1 overflow-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Config Bancos -->
                    <div>
                        <h4 class="text-brand-accent font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-building-columns"></i> Bancos</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-bank" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-accent outline-none" placeholder="Novo banco...">
                            <button onclick="addSettingItem('banks', 'new-bank')" class="bg-brand-accent hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-banks" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>

                    <!-- Config Categorias -->
                    <div>
                        <h4 class="text-brand-despesa font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-tag"></i> Categorias</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-cat" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-despesa outline-none" placeholder="Nova categoria...">
                            <button onclick="addSettingItem('categories', 'new-cat')" class="bg-brand-despesa hover:bg-rose-600 text-white px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-categories" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TRANSACTION -->
    <div id="modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('modal')"></div>
        <div class="relative w-full max-w-lg glass bg-[#0f172a] rounded-2xl shadow-2xl border border-slate-700 overflow-hidden animate-slide-up">
            <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 id="modal-title" class="font-display text-xl font-bold text-white">Nova Transação</h3>
                <button onclick="closeModal('modal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="form-transaction" class="p-6 space-y-4">
                <input type="hidden" id="form-type">
                <input type="hidden" id="form-id">
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descrição / Origem</label>
                    <input type="text" id="form-desc" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Ex: Salário, Mercado...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor (R$)</label>
                        <input type="text" id="form-val" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="0,00" oninput="formatCurrencyInput(this)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data</label>
                        <input type="date" id="form-date" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all cursor-pointer" onclick="try{this.showPicker()}catch(e){}">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Banco / Instituição</label>
                        <input type="text" id="form-bank" list="bank-list" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Selecione ou digite...">
                        <datalist id="bank-list"></datalist>
                    </div>
                    <div id="field-cat-container">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Categoria</label>
                        <input type="text" id="form-cat" list="cat-list" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all placeholder:text-slate-600" placeholder="Selecione ou digite...">
                        <datalist id="cat-list"></datalist>
                    </div>
                </div>

                <div id="field-def-container" class="hidden">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Definição (Regra 50/30/20)</label>
                    <select id="form-def" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none transition-all cursor-pointer appearance-none">
                        <option value="Necessidades (50%)">Necessidades (50%)</option>
                        <option value="Desejos (30%)">Desejos (30%)</option>
                        <option value="Poupança/Dívidas (20%)">Poupança/Dívidas (20%)</option>
                    </select>
                </div>

                <button type="submit" id="btn-save" class="w-full bg-brand-accent hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all mt-4 transform active:scale-[0.98]">
                    Salvar Registro
                </button>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, where, Timestamp, writeBatch, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWA5-o7lvPv7zybt1B-k7HdKcgPNYQOEc",
            authDomain: "planilha-financeira-fca35.firebaseapp.com",
            projectId: "planilha-financeira-fca35",
            storageBucket: "planilha-financeira-fca35.firebasestorage.app",
            messagingSenderId: "768116977602",
            appId: "1:768116977602:web:c824c055bf6f578eee305b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let transactions = [];
        let chartInstances = {};
        
        // Configurable Lists State
        let userSettings = {
            banks: ["Nubank", "Inter", "Itaú", "Bradesco", "Caixa", "Santander", "Carteira", "XP", "Binance"],
            categories: ["Moradia", "Alimentação", "Transporte", "Lazer", "Saúde", "Educação", "Investimento", "Assinaturas", "Outros"]
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.isAnonymous ? 'Visitante' : user.displayName.split(' ')[0];
                document.getElementById('user-avatar').src = user.photoURL || "https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff";
                await initSettings();
                loadData();
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('login-status').textContent = "";
            }
        });

        document.getElementById('btn-login-google').addEventListener('click', async () => {
            const status = document.getElementById('login-status');
            const errorMsg = document.getElementById('login-error');
            
            try {
                status.textContent = "Conectando ao Google...";
                errorMsg.classList.add('hidden');
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/unauthorized-domain' || error.code === 'auth/operation-not-supported-in-this-environment') {
                    status.textContent = "Ambiente de teste detectado...";
                    errorMsg.textContent = "Domínio de teste. Entrando como Visitante...";
                    errorMsg.classList.remove('hidden');
                    setTimeout(async () => {
                        try { await signInAnonymously(auth); } catch(e) { errorMsg.textContent = "Erro: " + e.message; }
                    }, 1500);
                } else {
                    status.textContent = "";
                    errorMsg.textContent = "Erro: " + error.message;
                    errorMsg.classList.remove('hidden');
                }
            }
        });

        window.signOut = () => signOut(auth);

        // --- SETTINGS MANAGEMENT ---
        async function initSettings() {
            if(!currentUser) return;
            const ref = doc(db, "user_settings", currentUser.uid);
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                const data = snap.data();
                if(data.banks) userSettings.banks = data.banks;
                if(data.categories) userSettings.categories = data.categories;
            } else {
                await setDoc(ref, userSettings);
            }
            updateDropdowns(); 
            setupDropdownBehavior('form-bank');
            setupDropdownBehavior('form-cat');
        }

        async function saveSettings() {
            if(!currentUser) return;
            await setDoc(doc(db, "user_settings", currentUser.uid), userSettings, {merge: true});
            updateDropdowns();
            renderSettingsList();
        }

        window.openSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsList();
        }

        window.addSettingItem = async (type, inputId) => {
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if(!val) return;
            if(!userSettings[type].includes(val)) {
                userSettings[type].push(val);
                userSettings[type].sort();
                input.value = '';
                await saveSettings();
            }
        }

        window.removeSettingItem = async (type, val) => {
            if(confirm(`Remover "${val}" da lista?`)) {
                userSettings[type] = userSettings[type].filter(item => item !== val);
                await saveSettings();
            }
        }

        function renderSettingsList() {
            const render = (type, listId) => {
                const ul = document.getElementById(listId);
                ul.innerHTML = '';
                userSettings[type].forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700";
                    li.innerHTML = `
                        <span class="text-sm text-slate-300">${item}</span>
                        <button onclick="removeSettingItem('${type}', '${item}')" class="text-slate-500 hover:text-rose-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    `;
                    ul.appendChild(li);
                });
            };
            render('banks', 'list-banks');
            render('categories', 'list-categories');
        }

        function updateDropdowns() {
            const populate = (id, list) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                list.forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    el.appendChild(opt);
                });
            };
            populate('bank-list', userSettings.banks);
            populate('cat-list', userSettings.categories);
        }
        
        function setupDropdownBehavior(inputId) {
            const input = document.getElementById(inputId);
            let previousValue = "";
            if(!input) return;
            input.addEventListener('focus', () => {
                previousValue = input.value;
                input.value = ''; 
            });
            input.addEventListener('blur', () => {
                if(input.value === '' && previousValue !== '') input.value = previousValue;
            });
            input.addEventListener('input', () => {
                if(input.value !== '') previousValue = input.value;
            });
        }

        // --- DATA LOAD ---
        function loadData() {
            const q = query(collection(db, "transacoes_financeiras"), orderBy("date", "desc"));
            onSnapshot(q, (snap) => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.uid === currentUser.uid);
                updateInterface();
            });
        }

        // --- CURRENCY MASK ---
        window.formatCurrencyInput = (input) => {
            let value = input.value.replace(/\D/g, "");
            value = (Number(value) / 100).toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = value === '0,00' ? '' : value;
        };

        // --- DASHBOARD CORE LOGIC ---
        function updateInterface() {
            // Filters
            const monthFilter = document.getElementById('filter-month').value; // Datagrid month
            const dashboardMonth = document.getElementById('dash-filter-month').value; // Dashboard month
            const searchFilter = document.getElementById('grid-search').value.toLowerCase();

            // 1. Update Datagrid (Uses global filter)
            let filteredData = transactions;
            if(monthFilter) filteredData = filteredData.filter(t => t.date.startsWith(monthFilter));
            
            const tableData = filteredData.filter(t => 
                (t.title && t.title.toLowerCase().includes(searchFilter)) || 
                (t.category && t.category.toLowerCase().includes(searchFilter)) ||
                (t.bank && t.bank.toLowerCase().includes(searchFilter))
            );

            const receitasTable = tableData.filter(t => t.type === 'receita');
            const despesasTable = tableData.filter(t => t.type === 'despesa');

            renderTable('tbody-receitas', receitasTable, ['date', 'title', 'bank', 'value'], 'receita');
            renderTable('tbody-despesas', despesasTable, ['date', 'title', 'category', 'definition', 'bank', 'value'], 'despesa');
            
            document.getElementById('tab-badge-rec').textContent = receitasTable.length;
            document.getElementById('tab-badge-desp').textContent = despesasTable.length;

            // 2. Update Dashboard Analytical (Uses specific dashboard filter)
            if(document.getElementById('dashboard-full').style.display !== 'none' || document.getElementById('dashboard-full').classList.contains('active')) {
                updateDashboardAnalytics(dashboardMonth);
            }
        }

        function updateDashboardAnalytics(selectedMonth) {
            // Se nenhum mês selecionado no dashboard, usa o atual
            if(!selectedMonth) {
                const now = new Date();
                selectedMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                document.getElementById('dash-filter-month').value = selectedMonth;
            }

            const currentYear = selectedMonth.split('-')[0];
            const fmt = new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'});

            // Data Subsets
            const monthData = transactions.filter(t => t.date.startsWith(selectedMonth));
            const yearData = transactions.filter(t => t.date.startsWith(currentYear));

            // KPIs Calculation
            // Receita Total
            const totalRec = monthData.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.value, 0);
            
            // Separação de Investimento vs Despesa Real
            const allOutflows = monthData.filter(t => t.type === 'despesa');
            const investments = allOutflows.filter(t => t.category === 'Investimento' || t.title.toLowerCase().includes('investimento'));
            const realExpenses = allOutflows.filter(t => t.category !== 'Investimento' && !t.title.toLowerCase().includes('investimento'));

            const valInvest = investments.reduce((sum, t) => sum + t.value, 0);
            const valExp = realExpenses.reduce((sum, t) => sum + t.value, 0);
            
            // Saldo é baseado no total absoluto do usuário (histórico completo) ou mês? 
            // Dashboard executivo geralmente mostra saldo do período ou acumulado. Vamos fazer fluxo de caixa do mês.
            const monthBalance = totalRec - (valExp + valInvest);

            // Update DOM KPIs
            document.getElementById('dash-rec').textContent = fmt.format(totalRec);
            document.getElementById('dash-desp').textContent = fmt.format(valExp);
            document.getElementById('dash-saldo').textContent = fmt.format(monthBalance);

            // Gauge C: Meta de Gastos (Simulação visual no card de Despesas)
            // Lógica: Se gastos > 80% da receita (e receita > 0), alerta amarelo. Se > 100%, vermelho.
            const cardDespesa = document.getElementById('card-despesa-kpi');
            const kpiStatus = document.getElementById('kpi-despesa-status');
            
            if(totalRec > 0) {
                const ratio = valExp / totalRec;
                if(ratio > 1) {
                    cardDespesa.classList.add('border', 'border-brand-despesa');
                    kpiStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> <span>Estouro de Orçamento!</span>`;
                } else if(ratio > 0.8) {
                    cardDespesa.classList.add('border', 'border-brand-warning');
                    kpiStatus.innerHTML = `<i class="fa-solid fa-circle-exclamation text-brand-warning"></i> <span class="text-brand-warning">Atenção (80%+)</span>`;
                } else {
                    cardDespesa.classList.remove('border', 'border-brand-despesa', 'border-brand-warning');
                    kpiStatus.innerHTML = `<i class="fa-solid fa-check text-brand-receita"></i> <span class="text-brand-receita">Dentro da meta</span>`;
                }
            } else {
                kpiStatus.innerHTML = `<i class="fa-solid fa-minus"></i> <span>Sem Receita</span>`;
            }

            // Gauge F: Meta de Investimentos (Usando o SVG Circle)
            // Meta simulada: 20% da receita líquida deveria ser investimento
            const savingsRate = totalRec > 0 ? (valInvest / totalRec) * 100 : 0;
            const savingsGoal = 20; // 20%
            
            // Normaliza para o círculo (0 a 100%)
            // Se atingiu 20%, o círculo deve estar cheio? Ou mostrar a taxa real? Vamos mostrar a taxa real.
            // Círculo full = 100%. Texto mostra %.
            
            document.getElementById('dash-eco-perc').textContent = `${savingsRate.toFixed(1)}%`;
            document.getElementById('label-inv-goal').textContent = `Investido (Meta: ${savingsGoal}%)`;

            const circle = document.getElementById('circle-progress');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            
            // Limita visualização a 100%
            const visualPercent = Math.min(savingsRate, 100);
            const offset = circumference - (visualPercent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            
            // Cor baseada na meta
            if(savingsRate >= savingsGoal) circle.style.stroke = '#10b981'; // Verde (Atingiu)
            else if(savingsRate >= savingsGoal / 2) circle.style.stroke = '#3b82f6'; // Azul (No caminho)
            else circle.style.stroke = '#f59e0b'; // Amarelo (Baixo)

            // --- CHARTS UPDATE ---
            updateCharts(yearData, monthData, currentYear);
        }

        function updateCharts(yearData, monthData, currentYear) {
            const commonOptions = {
                responsive: true, 
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { labels: { color: '#94a3b8', font: {family: 'Inter'} } },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                }
                                return label;
                            },
                            // Handle Horizontal Bar x-axis formatting
                            label: function(context) {
                                let val = context.raw;
                                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: '#334155', borderDash: [2, 4] }, 
                        ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#94a3b8' } 
                    }
                }
            };

            // Custom Plugin to Draw Data Labels above points (Only used for Timeline)
            const datalabelsPlugin = {
                id: 'datalabels',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx } = chart;
                    ctx.save();
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((element, index) => {
                            // Check if element is visible
                            if (!element.hidden) {
                                const data = dataset.data[index];
                                if(data !== null && data !== undefined && data !== 0) { // Only draw if not zero
                                    const valueStr = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(data);
                                    ctx.font = 'bold 10px Inter';
                                    ctx.fillStyle = '#cbd5e1'; // Slate-300
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    // Draw text slightly above the point
                                    ctx.fillText(valueStr, element.x, element.y - 8);
                                }
                            }
                        });
                    });
                    ctx.restore();
                }
            };

            // Chart D: Gastos vs Investimentos (Anual) - ID: chart-main
            // Aggregation Logic
            const monthsMap = {};
            for(let i=1; i<=12; i++) {
                const key = `${currentYear}-${String(i).padStart(2,'0')}`;
                monthsMap[key] = { expense: 0, invest: 0 };
            }

            yearData.forEach(t => {
                const k = t.date.substring(0, 7);
                if(monthsMap[k] && t.type === 'despesa') {
                    if(t.category === 'Investimento' || t.title.toLowerCase().includes('investimento')) {
                        monthsMap[k].invest += t.value;
                    } else {
                        monthsMap[k].expense += t.value;
                    }
                }
            });

            // Prepare Data Arrays
            const monthKeys = Object.keys(monthsMap).sort();
            const dataExp = monthKeys.map(k => monthsMap[k].expense);
            const dataInv = monthKeys.map(k => monthsMap[k].invest);
            
            // Fixed Labels: JAN, FEV, MAR...
            const fixedMonthLabels = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];

            if(chartInstances.main) chartInstances.main.destroy();
            chartInstances.main = new Chart(document.getElementById('chart-main'), {
                type: 'bar',
                plugins: [datalabelsPlugin], // Enable value labels above bars/points
                data: {
                    labels: fixedMonthLabels,
                    datasets: [
                        {
                            label: 'Soma de INVEST. NO MÊS',
                            data: dataInv,
                            type: 'line',
                            borderColor: '#fbbf24', // Gold/Yellow
                            backgroundColor: '#fbbf24',
                            borderWidth: 2,
                            borderDash: [5, 5], // Dotted line
                            pointBackgroundColor: '#fbbf24',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0, // Straight lines between points if implied, or keep smooth. Prompt says "Pontos visíveis". Usually financial lines are straight or slight curve. Let's use slight curve 0.
                            yAxisID: 'y1',
                            order: 1 // Line on top
                        },
                        {
                            label: 'Soma de GASTO NO MÊS',
                            data: dataExp,
                            backgroundColor: '#1f2937', // Dark Gray / Almost Black (Slate-800 is #1e293b, Gray-800 is #1f2937). Using specific dark color.
                            borderRadius: 0, // Solid appearance
                            borderWidth: 0, // No borders
                            yAxisID: 'y',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: {family: 'Inter', size: 11}, usePointStyle: true, boxWidth: 8 } 
                        },
                        tooltip: commonOptions.plugins.tooltip
                    },
                    scales: {
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#334155', borderDash: [2, 4] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // Only right ticks, no grid lines
                            ticks: { color: '#fbbf24', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });

            // NEW Chart: Top Categories (Restored as Bar) - ID: chart-top-cat
            const expenses = monthData.filter(t => t.type === 'despesa');
            const catMap = {};
            expenses.forEach(t => {
                const cat = t.category || 'Outros'; 
                catMap[cat] = (catMap[cat] || 0) + t.value;
            });
            const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 6);

            if(chartInstances.topCat) chartInstances.topCat.destroy();
            chartInstances.topCat = new Chart(document.getElementById('chart-top-cat'), {
                type: 'bar',
                data: {
                    labels: sortedCats.map(x => x[0]),
                    datasets: [{
                        label: 'Gasto',
                        data: sortedCats.map(x => x[1]),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#64748b'],
                        borderRadius: 4,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: commonOptions.plugins.tooltip
                    },
                    scales: {
                        y: { 
                            grid: { color: '#334155', borderDash: [2, 4] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });

            // Chart A (Renamed): Timeline Detail (Yellow Line) - ID: chart-timeline
            // Filter all month expenses, sort by Date
            const timelineExpenses = monthData.filter(t => t.type === 'despesa').sort((a,b) => new Date(a.date) - new Date(b.date));
            
            // FIXED: Using Category as requested
            const labelsLine = timelineExpenses.map(t => `${t.category} (${t.date.split('-')[2]}/${t.date.split('-')[1]})`);
            const dataLine = timelineExpenses.map(t => t.value);
            const totalLine = dataLine.reduce((a,b) => a+b, 0);

            // Update Totalizer in DOM
            const fmt = new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('chart-timeline-total').textContent = `Total do período: ${fmt.format(totalLine)}`;

            if(chartInstances.timeline) chartInstances.timeline.destroy();
            chartInstances.timeline = new Chart(document.getElementById('chart-timeline'), {
                type: 'line',
                plugins: [datalabelsPlugin], // Activate custom plugin
                data: {
                    labels: labelsLine,
                    datasets: [{
                        label: 'Valor',
                        data: dataLine,
                        borderColor: '#facc15', // Yellow-400
                        backgroundColor: '#facc15',
                        borderWidth: 2,
                        tension: 0.4, // Smooth curve
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#facc15',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return fmt.format(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: '#334155', borderDash: [5, 5] }, 
                            ticks: { color: '#94a3b8', callback: (val) => val.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}) } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 30 } 
                        }
                    }
                }
            });

            // Chart B: Gastos por Banco (Mês) - ID: chart-bank
            const bankMap = {};
            monthData.filter(t => t.type === 'despesa').forEach(t => {
                const b = t.bank || 'Carteira';
                bankMap[b] = (bankMap[b] || 0) + t.value;
            });
            const sortedBanks = Object.entries(bankMap).sort((a,b) => b[1] - a[1]).slice(0, 5);

            if(chartInstances.bank) chartInstances.bank.destroy();
            chartInstances.bank = new Chart(document.getElementById('chart-bank'), {
                type: 'bar',
                data: {
                    labels: sortedBanks.map(x => x[0]),
                    datasets: [{
                        label: 'Total',
                        data: sortedBanks.map(x => x[1]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: {weight: 'bold'} } }
                    }
                }
            });

            // Chart E: Ranking de Receitas (Mês) - ID: chart-type
            document.getElementById('title-chart-type').textContent = "Fontes de Receita";
            
            const recMap = {};
            monthData.filter(t => t.type === 'receita').forEach(t => {
                const o = t.origin || t.title || 'Diversos';
                recMap[o] = (recMap[o] || 0) + t.value;
            });
            const sortedRec = Object.entries(recMap).sort((a,b) => b[1] - a[1]).slice(0, 5);

            if(chartInstances.type) chartInstances.type.destroy();
            chartInstances.type = new Chart(document.getElementById('chart-type'), {
                type: 'bar', // Horizontal Bar
                data: {
                    labels: sortedRec.map(x => x[0]),
                    datasets: [{
                        label: 'Entrada',
                        data: sortedRec.map(x => x[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: {weight: 'bold'} } }
                    }
                }
            });
        }

        function renderTable(elementId, data, cols, type) {
